<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHEMISTRY TCG PRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;700&family=Noto+Sans+JP:wght@500;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0b0c15;
            --primary: #00e5ff;
            --accent: #ff0055;
            --card-base: #14141f;
            --card-frame: #2a2a3e;
            --text-main: #ffffff;
            --font-en: 'Chakra Petch', sans-serif;
            --font-jp: 'Noto Sans JP', sans-serif;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-dark);
            /* „Éá„Ç∏„Çø„É´Á©∫Èñì„ÅÆ„Çà„ÅÜ„Å™ËÉåÊôØ */
            background-image: 
                radial-gradient(circle at 50% -20%, #1a1a40 0%, #000000 100%),
                linear-gradient(0deg, transparent 24%, rgba(0, 229, 255, .05) 25%, rgba(0, 229, 255, .05) 26%, transparent 27%, transparent 74%, rgba(0, 229, 255, .05) 75%, rgba(0, 229, 255, .05) 76%, transparent 77%, transparent),
                linear-gradient(90deg, transparent 24%, rgba(0, 229, 255, .05) 25%, rgba(0, 229, 255, .05) 26%, transparent 27%, transparent 74%, rgba(0, 229, 255, .05) 75%, rgba(0, 229, 255, .05) 76%, transparent 77%, transparent);
            background-size: 100% 100%, 50px 50px, 50px 50px;
            font-family: var(--font-en);
            color: var(--text-main);
            height: 100dvh; width: 100vw;
            overflow: hidden;
            display: flex; flex-direction: column;
            perspective: 1200px; /* 3DÂäπÊûúÁî® */
        }

        /* --- ÁîªÈù¢ÁÆ°ÁêÜ --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; align-items: center;
            z-index: 10; padding: 20px; transition: 0.5s;
        }
        .screen.active { display: flex; opacity: 1; }

        /* --- UI„Éë„Éº„ÉÑ --- */
        .hud-header {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px; z-index: 100;
            display: flex; justify-content: space-between; align-items: center; padding: 0 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            font-family: var(--font-en); letter-spacing: 2px;
        }
        .energy-badge {
            background: rgba(0, 229, 255, 0.1); border: 1px solid var(--primary);
            color: var(--primary); padding: 5px 15px; border-radius: 4px;
            font-weight: bold; display: flex; align-items: center; gap: 8px;
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.3);
        }

        /* „Çµ„Ç§„Éê„Éº„Éú„Çø„É≥ */
        .cyber-btn {
            background: transparent; border: 2px solid var(--primary);
            color: var(--primary); padding: 15px 40px; font-size: 1.2rem; font-weight: bold;
            text-transform: uppercase; letter-spacing: 2px; cursor: pointer;
            position: relative; overflow: hidden; transition: 0.3s;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }
        .cyber-btn::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0,229,255,0.4), transparent);
            transition: 0.5s;
        }
        .cyber-btn:hover { background: rgba(0, 229, 255, 0.1); box-shadow: 0 0 20px var(--primary); }
        .cyber-btn:hover::before { left: 100%; }
        .cyber-btn:active { transform: scale(0.95); }

        .btn-red { border-color: var(--accent); color: var(--accent); }
        .btn-red:hover { background: rgba(255, 0, 85, 0.1); box-shadow: 0 0 20px var(--accent); }

        /* --- Êú¨Ê†ºÁöÑ„Ç´„Éº„Éâ„Éá„Ç∂„Ç§„É≥ --- */
        .card-wrapper {
            width: 110px; height: 160px; position: relative;
            flex-shrink: 0; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-origin: center bottom; cursor: pointer;
        }
        
        .tcg-card {
            width: 100%; height: 100%;
            background: #1a1a24;
            border-radius: 8px;
            border: 2px solid #444;
            display: flex; flex-direction: column;
            position: relative; overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        /* „É¨„Ç¢„É™„ÉÜ„Ç£Ë£ÖÈ£æ */
        .rarity-1 { border-color: #666; }
        .rarity-2 { border-color: var(--primary); box-shadow: 0 0 10px rgba(0,229,255,0.2); }
        .rarity-3 { border-color: #ffd700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); }
        /* „É¨„Ç¢„Ç´„Éº„Éâ„ÅÆ„Éõ„É≠„Ç∞„É©„É† */
        .rarity-3::after {
            content: ""; position: absolute; inset: 0;
            background: linear-gradient(125deg, transparent 30%, rgba(255,255,255,0.3) 45%, transparent 60%);
            background-size: 200% 200%; animation: holoShine 3s infinite linear; pointer-events: none;
        }
        @keyframes holoShine { 0%{background-position: 100% 0} 100%{background-position: -100% 0} }

        /* „Ç´„Éº„ÉâÂÜÖÈÉ®„É¨„Ç§„Ç¢„Ç¶„Éà */
        .card-header {
            height: 20px; display: flex; justify-content: space-between; align-items: center;
            padding: 0 4px; background: rgba(0,0,0,0.3);
        }
        .card-cost {
            width: 18px; height: 18px; border-radius: 50%;
            background: var(--primary); color: #000; font-weight: bold; font-size: 0.8rem;
            display: flex; justify-content: center; align-items: center; z-index: 2;
        }
        .card-image-box {
            width: 100%; height: 80px; background: #000;
            border-top: 1px solid #444; border-bottom: 1px solid #444;
            display: flex; justify-content: center; align-items: center;
            position: relative;
        }
        .card-image-box img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }
        .card-text-box {
            flex: 1; padding: 4px; background: linear-gradient(to bottom, #1a1a24, #0b0c15);
            display: flex; flex-direction: column;
        }
        .card-name { font-family: var(--font-jp); font-size: 0.65rem; font-weight: bold; color: #fff; margin-bottom: 2px; }
        .card-type { font-size: 0.5rem; color: #aaa; text-transform: uppercase; }
        .card-power { 
            margin-top: auto; align-self: flex-end; font-size: 1rem; font-weight: 900; 
            color: #fff; text-shadow: 0 0 5px var(--primary);
        }

        /* ÊïµÔºà„Éú„ÇπÔºâ„Ç´„Éº„Éâ„Éá„Ç∂„Ç§„É≥ */
        .boss-card {
            width: 130px; height: 180px;
            background: linear-gradient(180deg, #2a0a0a, #000);
            border: 3px solid var(--accent); border-radius: 10px;
            box-shadow: 0 0 30px rgba(255, 0, 85, 0.4);
            display: flex; flex-direction: column; align-items: center;
            position: relative; transform-style: preserve-3d;
            animation: bossFloat 4s infinite ease-in-out;
        }
        @keyframes bossFloat { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }
        
        .boss-img { 
            width: 100%; height: 100px; background: #000; 
            border-bottom: 2px solid var(--accent); 
            display: flex; justify-content: center; align-items: center; font-size: 3rem;
        }
        .boss-name { 
            font-family: var(--font-jp); color: var(--accent); font-weight: bold; 
            margin-top: 10px; font-size: 0.9rem; text-shadow: 0 0 5px var(--accent);
        }
        .boss-intent {
            position: absolute; top: -15px; right: -10px;
            background: #000; border: 1px solid var(--accent); color: var(--accent);
            padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: bold;
            box-shadow: 0 0 10px var(--accent);
        }

        /* ÊâãÊú≠„Ç®„É™„Ç¢ÔºàÊâáÁä∂ÈÖçÁΩÆÔºâ */
        .hand-area {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 180px;
            display: flex; justify-content: center; align-items: flex-end;
            padding-bottom: 20px; z-index: 50;
            perspective: 1000px;
        }
        .card-wrapper.in-hand {
            margin-left: -30px; /* „Ç´„Éº„Éâ„ÇíÈáç„Å≠„Çã */
            box-shadow: -5px 0 10px rgba(0,0,0,0.5);
        }
        .card-wrapper.in-hand:hover {
            transform: translateY(-40px) scale(1.2) !important;
            z-index: 100; margin: 0 10px;
        }
        .card-wrapper.disabled { filter: grayscale(1) brightness(0.4); pointer-events: none; }

        /* --- „Éê„Éà„É´„Éï„Ç£„Éº„É´„ÉâÊßãÊàê --- */
        .battle-stage {
            width: 100%; height: 100%; display: flex; flex-direction: column;
            transform-style: preserve-3d;
        }
        
        .zone-enemy { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .zone-field { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; }
        
        /* Âè¨Âñö„Çπ„É≠„ÉÉ„Éà */
        .summon-slot {
            width: 110px; height: 160px; border: 2px dashed rgba(255,255,255,0.2); border-radius: 8px;
            display: flex; justify-content: center; align-items: center;
            color: rgba(255,255,255,0.2); font-size: 0.8rem; letter-spacing: 2px;
            transform: rotateX(30deg); transition: 0.3s;
        }
        .summon-slot.active { border-color: var(--primary); background: rgba(0,229,255,0.1); box-shadow: 0 0 30px rgba(0,229,255,0.2); }

        /* „Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†± */
        .zone-player-stats {
            position: absolute; bottom: 180px; width: 100%; padding: 0 20px;
            display: flex; justify-content: space-between; align-items: flex-end; z-index: 40;
        }
        
        /* HP„Éê„Éº */
        .hp-container { width: 140px; }
        .hp-label { font-size: 0.7rem; color: #aaa; margin-bottom: 2px; }
        .hp-track { height: 8px; background: #222; border-radius: 4px; overflow: hidden; border: 1px solid #444; }
        .hp-fill { height: 100%; width: 100%; transition: width 0.4s; }
        .hp-p { background: linear-gradient(90deg, #00ff88, #00b862); box-shadow: 0 0 10px #00ff88; }
        .hp-e { background: linear-gradient(90deg, #ff0055, #b3003b); box-shadow: 0 0 10px #ff0055; }

        /* „Éû„Éä„Ç≤„Éº„Ç∏ („ÇØ„É™„Çπ„Çø„É´) */
        .mana-container { display: flex; gap: 5px; }
        .mana-crystal {
            width: 15px; height: 25px; background: #222; border: 1px solid #444;
            transform: skewX(-20deg); transition: 0.3s;
        }
        .mana-crystal.on { background: var(--primary); border-color: #fff; box-shadow: 0 0 10px var(--primary); }

        /* „Çø„Éº„É≥ÈñãÂßã„ÇØ„Ç§„Ç∫„É¢„Éº„ÉÄ„É´ („Ç™„Éº„Éê„Éº„É¨„Ç§) */
        .quiz-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 500;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(10px); animation: fadeIn 0.3s;
        }
        .quiz-box {
            background: rgba(20, 20, 30, 0.95); border: 2px solid var(--primary);
            padding: 30px; width: 90%; max-width: 400px; border-radius: 12px;
            text-align: center; box-shadow: 0 0 50px rgba(0, 229, 255, 0.3);
        }
        .quiz-title { color: var(--primary); font-size: 1.5rem; margin-bottom: 20px; font-weight: bold; letter-spacing: 2px; }
        .quiz-option {
            background: rgba(255,255,255,0.05); border: 1px solid #444; color: #fff;
            padding: 15px; width: 100%; margin-bottom: 10px; cursor: pointer; transition: 0.2s;
            font-family: var(--font-jp); font-weight: bold;
        }
        .quiz-option:hover { background: rgba(0, 229, 255, 0.2); border-color: var(--primary); }

        /* „Çø„Éº„É≥Ë°®Á§∫„Ç´„ÉÉ„Éà„Ç§„É≥ */
        .turn-cutin {
            position: fixed; top: 40%; left: 0; width: 100%; padding: 20px 0;
            background: rgba(0,0,0,0.8); border-top: 2px solid #fff; border-bottom: 2px solid #fff;
            text-align: center; font-size: 3rem; font-weight: 900; color: #fff; letter-spacing: 5px;
            z-index: 400; transform: scaleY(0); transition: 0.3s; pointer-events: none;
        }
        .turn-cutin.show { transform: scaleY(1); }

        /* ÊîªÊíÉ„Éú„Çø„É≥ */
        #attack-btn {
            position: absolute; bottom: 20px;
            background: var(--accent); color: #fff; border: 2px solid #fff;
            padding: 15px 50px; font-size: 1.2rem; font-weight: 900;
            border-radius: 30px; box-shadow: 0 0 20px var(--accent);
            cursor: pointer; z-index: 200; display: none;
            animation: pulseBtn 1s infinite;
        }
        @keyframes pulseBtn { 0%{transform:scale(1);} 50%{transform:scale(1.05);} 100%{transform:scale(1);} }

        /* „ÉÄ„É°„Éº„Ç∏ÊºîÂá∫ */
        .float-text {
            position: absolute; font-size: 3rem; font-weight: 900; color: #fff;
            text-shadow: 0 0 10px red; pointer-events: none; z-index: 300;
            animation: floatUp 1s forwards;
        }
        @keyframes floatUp { to { transform: translateY(-100px) scale(1.5); opacity: 0; } }

    </style>
</head>
<body>

    <header class="hud-header">
        <div style="font-weight:900;">CHEM<span style="color:var(--primary)">.TCG</span></div>
        <div class="energy-badge">‚ö° <span id="energy-val">0</span></div>
    </header>

    <div id="screen-login" class="screen active" style="justify-content:center;">
        <h1 style="font-size:3.5rem; text-align:center; text-shadow:0 0 20px var(--primary); margin-bottom:50px;">
            CHEMISTRY<br>TCG PRO
        </h1>
        <input type="text" id="login-name" placeholder="ENTER NAME" style="background:transparent; border:none; border-bottom:2px solid var(--primary); color:#fff; font-size:1.5rem; text-align:center; width:250px; padding:10px; font-family:var(--font-en);">
        <div style="height:30px;"></div>
        <button class="cyber-btn" onclick="login()">GAME START</button>
    </div>

    <div id="screen-home" class="screen">
        <div style="margin-top:80px; width:100%;">
            <div style="border-left:4px solid var(--primary); padding-left:20px; margin-bottom:30px;">
                <div style="font-size:0.8rem; color:#aaa;">PLAYER</div>
                <div style="font-size:2rem; font-weight:bold;" id="home-name">GUEST</div>
            </div>
            
            <div style="display:flex; gap:20px; margin-bottom:40px;">
                <div style="flex:1; background:rgba(255,255,255,0.05); padding:20px; border:1px solid #333; text-align:center;">
                    <div style="color:#aaa; font-size:0.8rem;">DECK</div>
                    <div style="font-size:2rem; font-weight:bold;" id="card-count">0</div>
                </div>
                <div style="flex:1; background:rgba(255,255,255,0.05); padding:20px; border:1px solid #333; text-align:center;">
                    <div style="color:#aaa; font-size:0.8rem;">RANK</div>
                    <div style="font-size:2rem; color:var(--primary); font-weight:bold;">C</div>
                </div>
            </div>

            <button class="cyber-btn btn-red" style="width:100%; margin-bottom:20px;" onclick="initBattle()">‚öîÔ∏è DUEL START</button>
            <button class="cyber-btn" style="width:100%;" onclick="navTo('gacha')">üíé CARD GACHA</button>
        </div>
    </div>

    <div id="screen-battle" class="screen" style="padding:0;">
        <div class="battle-stage">
            
            <div class="zone-enemy">
                <div class="boss-card" id="enemy-visual">
                    <div class="boss-intent" id="enemy-intent">‚ö† ATK 30</div>
                    <div class="boss-img">üëπ</div>
                    <div class="boss-name">BOSS: ÊøÉÁ°´ÈÖ∏</div>
                </div>
                
                <div style="margin-top:15px;">
                    <div class="hp-container">
                        <div class="hp-track"><div id="enemy-hp-bar" class="hp-fill hp-e" style="width:100%;"></div></div>
                        <div style="text-align:right; font-size:0.7rem; margin-top:2px;">HP: <span id="enemy-hp-text">200</span></div>
                    </div>
                </div>
            </div>

            <div class="zone-field">
                <div class="summon-slot" id="field-slot">PLACE CARD</div>
                
                <div id="attack-btn" onclick="playCard()">ACTIVATE</div>
            </div>

            <div class="zone-player-stats">
                <div class="hp-container">
                    <div class="hp-label">PLAYER HP</div>
                    <div class="hp-track"><div id="player-hp-bar" class="hp-fill hp-p" style="width:100%;"></div></div>
                    <div style="font-size:0.7rem; margin-top:2px;"><span id="player-hp-text">100</span></div>
                </div>
                <div>
                    <div class="hp-label" style="text-align:right;">MANA</div>
                    <div class="mana-container" id="mana-gauge">
                        </div>
                </div>
            </div>

            <div class="hand-area" id="hand-container">
                </div>
        </div>

        <div id="quiz-overlay" class="quiz-overlay">
            <div class="quiz-box">
                <div style="font-size:0.8rem; color:var(--primary); margin-bottom:5px;">DRAW PHASE</div>
                <div class="quiz-title">MANA CHARGE</div>
                <p id="q-text" style="font-family:var(--font-jp); margin-bottom:20px; font-weight:bold;">ÂïèÈ°åÊñá</p>
                <div id="q-options"></div>
            </div>
        </div>

        <div id="turn-cutin" class="turn-cutin">PLAYER TURN</div>
    </div>

    <div id="screen-gacha" class="screen" style="justify-content:center;">
        <h2 style="color:var(--primary); letter-spacing:5px;">MATERIALIZE</h2>
        <div style="width:220px; height:300px; border:2px solid var(--primary); display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 0 30px rgba(0,229,255,0.2); background:rgba(0,0,0,0.5);" onclick="tryGacha()">
            <div style="font-size:4rem; color:var(--primary);">üì¶</div>
        </div>
        <div style="margin-top:30px; font-weight:bold;">COST: 300 ‚ö°</div>
        <button class="cyber-btn" style="margin-top:30px;" onclick="navTo('home')">RETURN</button>
    </div>

    <div id="result-overlay" class="quiz-overlay">
        <h1 style="font-size:4rem; color:var(--primary); text-shadow:0 0 20px var(--primary);">VICTORY</h1>
        <div style="font-size:2rem; margin-bottom:30px;">+200 ‚ö°</div>
        <button class="cyber-btn" onclick="navTo('home')">RETURN BASE</button>
    </div>

    <script>
        // --- „Éá„Éº„Çø ---
        const cards = [
            {id:1, name:"Ê∞¥Á¥†", type:"atk", val:30, cost:1, rarity:1, img:"H‚ÇÇ"},
            {id:2, name:"ÈªíÈâõ", type:"def", val:20, cost:1, rarity:1, img:"C"},
            {id:3, name:"Â°©ÈÖ∏", type:"atk", val:50, cost:2, rarity:2, img:"HCl"},
            {id:4, name:"„Ç¢„É≥„É¢„Éã„Ç¢", type:"heal", val:40, cost:2, rarity:2, img:"NH‚ÇÉ"},
            {id:5, name:"„Éô„É≥„Çº„É≥", type:"def", val:50, cost:3, rarity:3, img:"C‚ÇÜH‚ÇÜ"},
            {id:6, name:"ÁéãÊ∞¥", type:"atk", val:80, cost:3, rarity:3, img:"AuÊ∫∂"}
        ];
        const quizList = [
            {q:"ÂéüÂ≠êÁï™Âè∑1Áï™„ÅÆÂÖÉÁ¥†„ÅØÔºü", a:0, o:["Ê∞¥Á¥†","„Éò„É™„Ç¶„É†","„É™„ÉÅ„Ç¶„É†"]},
            {q:"Na„ÅÆÁÇéËâ≤ÂèçÂøú„ÅØ‰ΩïËâ≤Ôºü", a:1, o:["Ëµ§","ÈªÑ","Á∑ë"]},
            {q:"ËÖêÂçµËá≠„Åå„Åô„ÇãÊ∞ó‰Ωì„ÅØÔºü", a:0, o:["Á°´ÂåñÊ∞¥Á¥†","ÈÖ∏Á¥†","Á™íÁ¥†"]},
            {q:"„ÉÄ„Ç§„É§„É¢„É≥„Éâ„ÅÆÂêåÁ¥†‰Ωì„ÅØÔºü", a:2, o:["Ê∞¥Êô∂","„Ç¨„É©„Çπ","ÈªíÈâõ"]}
        ];

        // --- Â§âÊï∞ ---
        let user = null, myCards = [], energy = 500;
        let enemyMaxHp=200, enemyHp=200, playerMaxHp=100, playerHp=100;
        let playerMana=0; const maxMana=5;
        let selectedCard=null, nextEnemyAction={type:'atk', val:30};
        let isPlayerTurn = false; // Êìç‰ΩúÂèØËÉΩ„Åã

        // --- „Ç∑„Çπ„ÉÜ„É† ---
        function login() {
            const name = document.getElementById('login-name').value;
            if(!name) return alert("ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
            user = name;
            const saved = localStorage.getItem('chemTCGPro_'+user);
            if(saved) {
                const d = JSON.parse(saved); myCards = d.cards; energy = d.energy;
            } else {
                myCards = [cards[0], cards[1], cards[2]]; saveData();
            }
            document.getElementById('home-name').innerText = user;
            updateGlobalUI();
            navTo('home');
        }

        function saveData() { if(user) localStorage.setItem('chemTCGPro_'+user, JSON.stringify({cards:myCards, energy:energy})); }
        function updateGlobalUI() {
            document.getElementById('energy-val').innerText = energy;
            document.getElementById('card-count').innerText = myCards.length;
        }

        function navTo(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-'+screenId).classList.add('active');
            if(screenId !== 'battle') document.getElementById('result-overlay').style.display='none';
        }

        // --- „Éê„Éà„É´ ---
        function initBattle() {
            navTo('battle');
            enemyHp=enemyMaxHp; playerHp=playerMaxHp; playerMana=0;
            selectedCard=null; isPlayerTurn=false;
            
            // UI„É™„Çª„ÉÉ„Éà
            document.getElementById('field-slot').innerHTML = "PLACE CARD";
            document.getElementById('field-slot').className = "summon-slot";
            document.getElementById('attack-btn').style.display = 'none';
            document.getElementById('result-overlay').style.display = 'none';
            
            decideEnemyAction();
            updateBattleUI();
            
            // ‚òÖÈñãÂπïÔºöËá™ÂàÜ„ÅÆ„Çø„Éº„É≥ÈñãÂßãÔºà„ÇØ„Ç§„Ç∫„Å∏Ôºâ
            setTimeout(startPlayerTurn, 1000);
        }

        function decideEnemyAction() {
            const r = Math.random();
            if(r < 0.7) {
                nextEnemyAction = {type:'atk', val:30 + Math.floor(Math.random()*10)};
                document.getElementById('enemy-intent').innerHTML = `‚ö† ATK ${nextEnemyAction.val}`;
                document.getElementById('enemy-intent').style.color = "var(--accent)";
            } else {
                nextEnemyAction = {type:'wait', val:0};
                document.getElementById('enemy-intent').innerHTML = `üí§ IDLE`;
                document.getElementById('enemy-intent').style.color = "#aaa";
            }
        }

        function updateBattleUI() {
            // HP
            document.getElementById('enemy-hp-bar').style.width = (enemyHp/enemyMaxHp)*100+"%";
            document.getElementById('enemy-hp-text').innerText = enemyHp;
            document.getElementById('player-hp-bar').style.width = (playerHp/playerMaxHp)*100+"%";
            document.getElementById('player-hp-text').innerText = playerHp;
            
            // Mana
            const mBox = document.getElementById('mana-gauge'); mBox.innerHTML = "";
            for(let i=0; i<maxMana; i++){
                const d = document.createElement('div');
                d.className = `mana-crystal ${i<playerMana?'on':''}`;
                mBox.appendChild(d);
            }
            renderHand();
        }

        function renderHand() {
            const el = document.getElementById('hand-container'); el.innerHTML = "";
            myCards.slice().reverse().forEach((c, idx) => {
                const div = document.createElement('div');
                div.className = "card-wrapper in-hand";
                div.style.transform = `rotate(${(idx-myCards.length/2)*5}deg) translateY(${Math.abs(idx-myCards.length/2)*5}px)`; // ÊâáÁä∂ÈÖçÁΩÆ
                
                // „Éû„Éä‰∏çË∂≥„Å™„ÇâÊöó„Åè
                if(c.cost > playerMana) div.classList.add('disabled');

                let typeStr = "ATK"; 
                if(c.type==='def') typeStr="DEF"; 
                if(c.type==='heal') typeStr="HEAL";

                div.innerHTML = `
                    <div class="tcg-card rarity-${c.rarity}">
                        <div class="card-header">
                            <div class="card-cost">${c.cost}</div>
                            <div class="card-type">${typeStr}</div>
                        </div>
                        <div class="card-image-box">
                            <img src="https://placehold.co/100x80/000/FFF?text=${c.img}" alt="">
                        </div>
                        <div class="card-text-box">
                            <div class="card-name">${c.name}</div>
                            <div class="card-power">${c.val}</div>
                        </div>
                    </div>
                `;
                div.onclick = () => selectCard(c, div);
                el.appendChild(div);
            });
        }

        function selectCard(c, div) {
            if(!isPlayerTurn) return;
            if(c.cost > playerMana) return alert("„Éû„Éä„ÅåË∂≥„Çä„Åæ„Åõ„Çì");

            // „Ç´„Éº„ÉâÈÅ∏Êäû„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            document.querySelectorAll('.card-wrapper').forEach(d => d.style.transform = ""); // „É™„Çª„ÉÉ„Éà
            div.style.transform = "translateY(-50px) scale(1.1)";
            
            selectedCard = c;

            // „Éï„Ç£„Éº„É´„Éâ„Å´„Çª„ÉÉ„Éà
            const slot = document.getElementById('field-slot');
            slot.className = "summon-slot active";
            slot.innerHTML = div.querySelector('.tcg-card').outerHTML; // „Ç´„Éº„Éâ„Ç≥„Éî„Éº
            
            document.getElementById('attack-btn').style.display = 'block';
        }

        // --- „Çø„Éº„É≥„Éï„É≠„Éº ---
        function startPlayerTurn() {
            // 1. „ÇØ„Ç§„Ç∫Ë°®Á§∫ (Draw Phase)
            const q = quizList[Math.floor(Math.random()*quizList.length)];
            document.getElementById('q-text').innerText = q.q;
            const opts = document.getElementById('q-options'); opts.innerHTML = "";
            q.o.forEach((txt, i) => {
                const b = document.createElement('div');
                b.className = "quiz-option"; b.innerText = txt;
                b.onclick = () => finishDrawPhase(i === q.a);
                opts.appendChild(b);
            });
            document.getElementById('quiz-overlay').style.display = 'flex';
        }

        function finishDrawPhase(isCorrect) {
            document.getElementById('quiz-overlay').style.display = 'none';
            
            // „Éû„ÉäÂá¶ÁêÜ
            if(isCorrect) {
                playerMana = Math.min(maxMana, playerMana + 2);
                showCutin("MANA CHARGE!");
            } else {
                playerMana = Math.min(maxMana, playerMana + 1); // ‰∏çÊ≠£Ëß£„Åß„ÇÇ+1 (Ë©∞„ÅøÈò≤Ê≠¢)
                showCutin("DRAW PHASE");
            }
            updateBattleUI();

            // 2. „É°„Ç§„É≥„Éï„Çß„Éº„Ç∫ÈñãÂßã
            isPlayerTurn = true;
        }

        function playCard() {
            if(!isPlayerTurn || !selectedCard) return;
            
            playerMana -= selectedCard.cost;
            isPlayerTurn = false;
            document.getElementById('attack-btn').style.display = 'none';
            
            // ÂäπÊûúÁô∫Âãï
            if(selectedCard.type === 'atk') {
                const dmg = selectedCard.val;
                enemyHp = Math.max(0, enemyHp - dmg);
                showDamage(dmg, 'enemy-visual');
                document.getElementById('enemy-visual').style.animation = "shake 0.4s";
                setTimeout(()=>document.getElementById('enemy-visual').style.animation = "bossFloat 4s infinite", 400);
            } else if(selectedCard.type === 'heal') {
                const heal = selectedCard.val;
                playerHp = Math.min(playerMaxHp, playerHp + heal);
                showDamage(heal, 'player-hp-bar', '#00ff88');
            }
            
            // „Ç´„Éº„ÉâÊ∂àË≤ªÊºîÂá∫
            document.getElementById('field-slot').innerHTML = "";
            document.getElementById('field-slot').className = "summon-slot";
            updateBattleUI();

            if(enemyHp <= 0) setTimeout(showWin, 1000);
            else setTimeout(cpuTurn, 1500);
        }

        function cpuTurn() {
            showCutin("ENEMY TURN");
            setTimeout(() => {
                if(nextEnemyAction.type === 'atk') {
                    const dmg = nextEnemyAction.val;
                    playerHp = Math.max(0, playerHp - dmg);
                    showDamage(dmg, 'player-hp-bar', '#ff0055');
                }
                updateBattleUI();

                if(playerHp <= 0) {
                    alert("DEFEAT..."); navTo('home');
                } else {
                    decideEnemyAction();
                    setTimeout(startPlayerTurn, 1000); // Ê¨°„ÅÆ„Çø„Éº„É≥„Å∏
                }
            }, 1000);
        }

        // --- ÊºîÂá∫ ---
        function showCutin(text) {
            const el = document.getElementById('turn-cutin');
            el.innerText = text; el.classList.add('show');
            setTimeout(()=>el.classList.remove('show'), 1500);
        }

        function showDamage(val, targetId, color='#fff') {
            const t = document.getElementById(targetId).getBoundingClientRect();
            const el = document.createElement('div');
            el.className = 'float-text'; el.innerText = val;
            el.style.left = t.left + t.width/2 + "px";
            el.style.top = t.top + "px";
            el.style.color = color;
            document.body.appendChild(el);
            setTimeout(()=>el.remove(), 1000);
        }

        function showWin() {
            document.getElementById('result-overlay').style.display = 'flex';
            energy += 200; saveData(); updateGlobalUI();
        }

        // --- „Ç¨„ÉÅ„É£ ---
        function tryGacha() {
            if(energy < 300) return alert("Energy‰∏çË∂≥");
            energy -= 300; updateGlobalUI(); saveData();
            
            const r = Math.random();
            let rarity = 1; if(r<0.2) rarity=3; else if(r<0.5) rarity=2;
            const hit = cards.filter(c=>c.rarity===rarity)[0];
            myCards.push(hit); saveData(); updateGlobalUI();
            
            alert("GET: " + hit.name);
        }
    </script>
</body>
</html>