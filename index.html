<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>COSMIC CHEMISTRY V3.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;900&family=Zen+Dots&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-cyan: #00f3ff;
            --neon-blue: #0066ff;
            --neon-pink: #ff0055;
            --neon-gold: #ffd700;
            --neon-purple: #bc13fe;
            --bg-dark: #050b14;
            --glass: rgba(10, 20, 30, 0.7);
            --font-main: 'Rajdhani', sans-serif;
            --font-jp: 'Zen Dots', sans-serif;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 50% 120%, #1a0b2e 0%, #000000 70%),
                linear-gradient(0deg, rgba(0,243,255,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,243,255,0.05) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
            font-family: var(--font-main);
            color: #fff;
            height: 100dvh; width: 100vw;
            overflow: hidden;
        }

        /* --- ÂÖ±ÈÄö„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà --- */
        .screen {
            position: absolute; inset: 0; display: none; flex-direction: column;
            z-index: 10; opacity: 0; transition: opacity 0.5s;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
        }
        .screen.active { display: flex; opacity: 1; }

        .cyber-btn {
            background: rgba(0, 243, 255, 0.05); border: 1px solid var(--neon-cyan); color: var(--neon-cyan);
            padding: 12px 30px; font-weight: 900; letter-spacing: 2px; cursor: pointer; text-align: center;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            transition: 0.3s; text-transform: uppercase; position: relative; overflow: hidden;
            box-shadow: 0 0 10px rgba(0,243,255,0.1);
        }
        .cyber-btn:hover { background: var(--neon-cyan); color: #000; box-shadow: 0 0 20px var(--neon-cyan); }
        .cyber-btn.gold { border-color: var(--neon-gold); color: var(--neon-gold); }
        .cyber-btn.gold:hover { background: var(--neon-gold); color: #000; box-shadow: 0 0 20px var(--neon-gold); }
        .cyber-btn.pink { border-color: var(--neon-pink); color: var(--neon-pink); }
        .cyber-btn.pink:hover { background: var(--neon-pink); color: #000; box-shadow: 0 0 20px var(--neon-pink); }

        /* --- „É™„Ç¢„É´„Å™„Ç´„Éº„Éâ„Çπ„Çø„Ç§„É´ --- */
        .card-scene {
            width: 130px; height: 180px; perspective: 1000px;
            position: relative; margin: 5px; cursor: pointer;
        }
        .card-obj {
            width: 100%; height: 100%; position: relative;
            transform-style: preserve-3d; transition: transform 0.1s;
            border-radius: 8px;
        }
        .card-face {
            position: absolute; inset: 0; border-radius: 8px; overflow: hidden;
            background: #0a0f19; border: 2px solid #333;
            /* „Éè„Éã„Ç´„É†„ÉÜ„ÇØ„Çπ„ÉÅ„É£ */
            background-image: radial-gradient(circle, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 4px 4px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        
        /* „Éõ„É≠„Ç∞„É©„É†ÂèçÂ∞ÑÂ±§ */
        .holo-layer {
            position: absolute; inset: 0; pointer-events: none; z-index: 10; opacity: 0.6;
            background: linear-gradient(115deg, transparent 20%, rgba(255,255,255,0.4) 40%, rgba(255,255,255,0) 60%);
            mix-blend-mode: overlay; transition: opacity 0.3s;
            background-size: 200% 200%;
        }
        /* „É¨„Ç¢„Ç´„Éº„ÉâÁî®„É¨„Ç§„É≥„Éú„Éº„Éõ„É≠ */
        .rarity-3 .holo-layer {
            background: linear-gradient(115deg, transparent 30%, rgba(255,0,0,0.3) 40%, rgba(0,255,0,0.3) 50%, rgba(0,0,255,0.3) 60%, transparent 70%);
            mix-blend-mode: color-dodge;
        }

        .card-art {
            position: absolute; top: 25px; left: 5px; right: 5px; bottom: 60px;
            background: #000; border: 1px solid rgba(255,255,255,0.2);
        }
        .card-art img { width: 100%; height: 100%; object-fit: cover; }
        
        .card-cost {
            position: absolute; top: -2px; left: -2px; width: 30px; height: 30px;
            background: var(--neon-blue); clip-path: polygon(0 0, 100% 0, 0 100%);
            z-index: 20; display: flex; padding: 2px 0 0 5px; font-weight: 900; font-size: 1.1rem;
        }
        .card-content {
            position: absolute; bottom: 0; width: 100%; padding: 5px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
        }

        /* --- ÁîªÈù¢Âà•„Çπ„Çø„Ç§„É´ --- */
        
        /* LOGIN */
        #login-panel {
            background: var(--glass); border: 1px solid var(--neon-cyan); padding: 40px;
            text-align: center; clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
        }

        /* HOME */
        .home-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px;
            width: 100%; max-width: 600px; margin: auto;
        }
        .home-card {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
            padding: 20px; text-align: center; cursor: pointer; transition: 0.3s;
            display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 10px;
        }
        .home-card:hover { background: rgba(0,243,255,0.1); border-color: var(--neon-cyan); transform: translateY(-5px); }
        .icon-lg { font-size: 3rem; margin-bottom: 10px; display: block; }
        
        /* HEADER HUD */
        .hud {
            display: flex; justify-content: space-between; align-items: center; padding: 10px 20px;
            background: rgba(0,0,0,0.8); border-bottom: 1px solid #333; z-index: 100;
        }
        .energy-bar { display: flex; align-items: center; gap: 5px; color: var(--neon-gold); font-weight: bold; }

        /* BATTLE & PVP */
        .battle-area { display: flex; flex-direction: column; height: 100%; padding-bottom: 20px; }
        .enemy-zone { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; }
        .player-zone { height: 260px; position: relative; }
        
        /* GACHA */
        .gacha-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
        .capsule {
            width: 200px; height: 200px; border-radius: 50%;
            border: 5px solid var(--neon-cyan);
            box-shadow: 0 0 50px var(--neon-cyan);
            position: relative; cursor: pointer;
            animation: pulse 2s infinite; display: flex; justify-content: center; align-items: center; font-size: 5rem;
        }
        @keyframes pulse { 0%{box-shadow:0 0 20px var(--neon-cyan);} 50%{box-shadow:0 0 60px var(--neon-cyan), inset 0 0 20px var(--neon-cyan);} 100%{box-shadow:0 0 20px var(--neon-cyan);} }

        /* MATCHMAKING */
        .scan-line {
            width: 300px; height: 2px; background: var(--neon-pink);
            position: absolute; animation: scan 2s infinite linear;
            box-shadow: 0 0 10px var(--neon-pink);
        }
        @keyframes scan { 0%{top:30%; opacity:0;} 50%{opacity:1;} 100%{top:70%; opacity:0;} }

        /* Hand Layout */
        .hand-container {
            display: flex; justify-content: center; align-items: flex-end;
            position: absolute; bottom: 10px; width: 100%; height: 200px;
            perspective: 1000px; overflow-x: visible;
        }
        .hand-card-wrapper {
            margin-left: -40px; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-origin: center bottom;
        }
        .hand-card-wrapper:first-child { margin-left: 0; }
        .hand-card-wrapper:hover {
            transform: translateY(-80px) scale(1.3) rotate(0deg) !important;
            z-index: 100; margin: 0 30px;
        }

        /* Modal */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background: #111; border: 1px solid var(--neon-cyan); padding: 30px; width: 90%; max-width: 400px;
            text-align: center; position: relative;
        }
        .modal-content::before {
            content:""; position:absolute; top:-1px; left:-1px; width:10px; height:10px; border-top:2px solid var(--neon-cyan); border-left:2px solid var(--neon-cyan);
        }

    </style>
</head>
<body>

    <header class="hud" id="hud" style="display:none;">
        <div style="font-weight:bold;">RANK: <span id="hud-rank" style="color:var(--neon-cyan)">F</span> <span id="hud-name">GUEST</span></div>
        <div class="energy-bar">
            ‚ö° <span id="hud-energy">100</span>
        </div>
        <div class="cyber-btn" style="padding:5px 10px; font-size:0.8rem;" onclick="goHome()">HOME</div>
    </header>

    <div id="screen-login" class="screen active" style="justify-content:center; align-items:center;">
        <div id="login-panel">
            <h1 style="margin:0; font-size:2.5rem; color:#fff; text-shadow:0 0 10px var(--neon-cyan);">COSMIC<br><span style="color:var(--neon-cyan)">CHEMISTRY</span></h1>
            <p style="letter-spacing:3px; font-size:0.8rem; color:#aaa; margin-bottom:30px;">V3.0 ONLINE SYSTEM</p>
            <input type="text" id="username" placeholder="PILOT NAME" maxlength="8"
                   style="background:transparent; border:none; border-bottom:2px solid #555; color:#fff; font-size:1.5rem; text-align:center; margin-bottom:20px; width:100%; font-family:var(--font-main);">
            <div class="cyber-btn" onclick="login()">INITIALIZE</div>
        </div>
    </div>

    <div id="screen-home" class="screen" style="justify-content:center;">
        <h2 style="text-align:center; letter-spacing:5px;">MISSION SELECT</h2>
        <div class="home-grid">
            <div class="home-card" onclick="startPvE()">
                <div class="icon-lg" style="color:var(--neon-blue)">‚öîÔ∏è</div>
                <div style="font-weight:bold;">STORY OPS</div>
                <div style="font-size:0.7rem; color:#aaa;">CPU BATTLE<br>COST: 10‚ö°</div>
            </div>
            <div class="home-card" onclick="startPvP()">
                <div class="icon-lg" style="color:var(--neon-pink)">üåê</div>
                <div style="font-weight:bold;">ONLINE PVP</div>
                <div style="font-size:0.7rem; color:#aaa;">RANKED MATCH<br>COST: 20‚ö°</div>
            </div>
            <div class="home-card" onclick="startGacha()">
                <div class="icon-lg" style="color:var(--neon-gold)">üíé</div>
                <div style="font-weight:bold;">LABORATORY</div>
                <div style="font-size:0.7rem; color:#aaa;">QUIZ GACHA<br>COST: 50‚ö°</div>
            </div>
            <div class="home-card" onclick="showDeck()">
                <div class="icon-lg" style="color:var(--neon-purple)">üìÇ</div>
                <div style="font-weight:bold;">DATABASE</div>
                <div style="font-size:0.7rem; color:#aaa;">VIEW CARDS</div>
            </div>
        </div>
        <div style="text-align:center; margin-top:20px;">
            <div class="cyber-btn" onclick="addEnergy()">RECHARGE ENERGY (+50)</div>
        </div>
    </div>

    <div id="screen-matchmaking" class="screen" style="justify-content:center; align-items:center;">
        <div style="font-size:2rem; font-weight:bold; color:var(--neon-pink); text-shadow:0 0 10px var(--neon-pink);">SEARCHING RIVAL...</div>
        <div style="width:300px; height:100px; border:1px solid rgba(255,0,85,0.3); position:relative; margin-top:20px; background:rgba(0,0,0,0.5);">
            <div class="scan-line"></div>
            <div style="position:absolute; bottom:5px; right:5px; font-size:0.8rem; color:var(--neon-pink);">CONNECTING TO SECTOR 9...</div>
        </div>
    </div>

    <div id="screen-battle" class="screen">
        <div class="battle-area">
            <div class="enemy-zone">
                <div style="text-align:center;">
                    <div id="enemy-name-disp" style="color:var(--neon-pink); font-weight:bold; margin-bottom:5px;">UNKNOWN</div>
                    <img id="enemy-img" src="https://placehold.co/150x150/220000/ff0055?text=BOSS&font=roboto" style="border:2px solid var(--neon-pink); border-radius:50%; box-shadow:0 0 20px var(--neon-pink);">
                    <div style="margin-top:5px; width:200px; height:10px; background:#333; margin:10px auto;">
                        <div id="enemy-hp-bar" style="width:100%; height:100%; background:var(--neon-pink); transition:0.3s;"></div>
                    </div>
                    <div>HP: <span id="enemy-hp-text">500</span></div>
                </div>
            </div>

            <div style="height:50px; display:flex; justify-content:center; align-items:center;">
                <div id="combo-msg" style="font-size:2rem; font-weight:900; color:var(--neon-gold); text-shadow:0 0 10px var(--neon-gold); opacity:0;"></div>
            </div>

            <div class="player-zone">
                <div style="padding:10px; display:flex; justify-content:space-between; align-items:flex-end;">
                    <div>
                        <div style="font-size:0.8rem; color:#aaa;">SHIELD</div>
                        <div style="width:150px; height:10px; background:#333;">
                            <div id="player-hp-bar" style="width:100%; height:100%; background:var(--neon-blue); transition:0.3s;"></div>
                        </div>
                        <span id="player-hp-text">200</span>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:0.8rem; color:#aaa;">MANA (e‚Åª)</div>
                        <div id="mana-box" style="display:flex; gap:3px;"></div>
                    </div>
                </div>
                <div id="field-slot" style="position:absolute; top:-60px; left:50%; transform:translateX(-50%); width:100px; height:140px; border:2px dashed rgba(0,243,255,0.2); border-radius:8px; display:flex; justify-content:center; align-items:center; opacity:0.5; pointer-events:none;">
                    <span style="font-size:0.7rem;">REACTION SITE</span>
                </div>
                <div class="hand-container" id="hand-container"></div>
            </div>
        </div>
    </div>

    <div id="screen-gacha" class="screen">
        <div class="gacha-container">
            <h2 style="color:var(--neon-cyan);">MATTER SYNTHESIS</h2>
            <div class="capsule" onclick="tryOpenGacha()">?</div>
            <p style="margin-top:20px; color:#aaa;">TAP TO SYNTHESIZE (QUIZ REQUIRED)</p>
        </div>
    </div>

    <div id="modal-quiz" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--neon-gold);">SECURITY CHECK</h3>
            <p id="quiz-text" style="font-size:1.1rem; margin-bottom:20px;">Question here</p>
            <div id="quiz-options" style="display:flex; flex-direction:column; gap:10px;"></div>
        </div>
    </div>

    <div id="modal-reward" class="modal">
        <div class="modal-content" style="background:radial-gradient(circle, #222, #000);">
            <h2 style="color:var(--neon-gold); text-shadow:0 0 20px var(--neon-gold);">SYNTHESIS COMPLETE!</h2>
            <div id="reward-card-view" style="display:flex; justify-content:center; margin:30px 0;"></div>
            <div class="cyber-btn gold" onclick="closeReward()">ACCEPT</div>
        </div>
    </div>

    <script>
        // --- DATA & CONFIG ---
        const CARDS = [
            {id:1, name:"Hydrogen", jp:"Ê∞¥Á¥† (H‚ÇÇ)", cost:1, val:20, type:"ATK", elm:"H", rarity:1, img:"H"},
            {id:2, name:"Oxygen", jp:"ÈÖ∏Á¥† (O‚ÇÇ)", cost:1, val:10, type:"SUP", elm:"O", rarity:1, img:"O"},
            {id:3, name:"Sodium", jp:"„Éä„Éà„É™„Ç¶„É† (Na)", cost:2, val:30, type:"ATK", elm:"Na", rarity:2, img:"Na"},
            {id:4, name:"Chlorine", jp:"Â°©Á¥† (Cl‚ÇÇ)", cost:2, val:35, type:"ATK", elm:"Cl", rarity:2, img:"Cl"},
            {id:5, name:"Water", jp:"Ê∞¥ (H‚ÇÇO)", cost:2, val:30, type:"HEAL", elm:"H2O", rarity:1, img:"H2O"},
            {id:6, name:"Hydrochloric Acid", jp:"Â°©ÈÖ∏ (HCl)", cost:3, val:50, type:"ATK", elm:"Acid", rarity:3, img:"HCl"},
            {id:7, name:"Sodium Hydroxide", jp:"Ê∞¥ÈÖ∏ÂåñNa (NaOH)", cost:3, val:40, type:"DEF", elm:"Base", rarity:2, img:"NaOH"},
            {id:8, name:"Neon", jp:"„Éç„Ç™„É≥ (Ne)", cost:2, val:60, type:"DEF", elm:"Noble", rarity:3, img:"Ne"}
        ];

        const QUIZZES = [
            {q:"ÂéüÂ≠êÁï™Âè∑1Áï™„ÅÆÂÖÉÁ¥†„ÅØÔºü", a:0, o:["Ê∞¥Á¥†","„Éò„É™„Ç¶„É†","„É™„ÉÅ„Ç¶„É†"]},
            {q:"„ÄåÁéãÊ∞¥„Äç„ÅØ‰Ωï„Å®‰Ωï„ÅÆÊ∑∑ÂêàÊ∂≤Ôºü", a:0, o:["ÊøÉÂ°©ÈÖ∏„Å®ÊøÉÁ°ùÈÖ∏","ÊøÉÁ°´ÈÖ∏„Å®ÊøÉÂ°©ÈÖ∏","Ê∞¥„Å®„Ç®„Çø„Éé„Éº„É´"]},
            {q:"ÁÇéËâ≤ÂèçÂøú„Åß„ÄåÈªÑËâ≤„Äç„ÇíÁ§∫„Åô„ÅÆ„ÅØÔºü", a:1, o:["ÈäÖ","„Éä„Éà„É™„Ç¶„É†","„Ç´„É™„Ç¶„É†"]},
            {q:"pH„Åå7„Çà„ÇäÂ∞è„Åï„ÅÑÊ∂≤ÊÄß„ÅØÔºü", a:2, o:["„Ç¢„É´„Ç´„É™ÊÄß","‰∏≠ÊÄß","ÈÖ∏ÊÄß"]},
            {q:"„Éâ„É©„Ç§„Ç¢„Ç§„Çπ„ÅØ‰Ωï„ÅåÂõ∫„Åæ„Å£„Åü„ÇÇ„ÅÆÔºü", a:0, o:["‰∫åÈÖ∏ÂåñÁÇ≠Á¥†","Ê∞¥","ÈÖ∏Á¥†"]}
        ];

        let user = {
            name: "GUEST",
            rank: "F",
            energy: 100,
            collection: [1, 1, 2, 2, 5], // ÂàùÊúü„Éá„ÉÉ„Ç≠(ID)
            wins: 0
        };

        let battleState = {
            hp: 0, maxHp:0, eHp:0, eMaxHp:0, mana:0, maxMana:5,
            hand:[], field:null, isPvP:false, turn:0
        };

        // --- CORE FUNCTIONS ---
        
        window.onload = () => {
            loadUser();
            if(user.name !== "GUEST") {
                document.getElementById('username').value = user.name;
                updateHud();
            }
        };

        function loadUser() {
            const saved = localStorage.getItem('cosmic_user_v3');
            if(saved) user = JSON.parse(saved);
        }
        function saveUser() {
            localStorage.setItem('cosmic_user_v3', JSON.stringify(user));
            updateHud();
        }

        function updateHud() {
            document.getElementById('hud-name').innerText = user.name;
            document.getElementById('hud-rank').innerText = user.rank;
            document.getElementById('hud-energy').innerText = user.energy;
        }

        function login() {
            const n = document.getElementById('username').value || "PILOT";
            user.name = n;
            saveUser();
            document.getElementById('hud').style.display = 'flex';
            switchScreen('home');
        }

        function switchScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + id).classList.add('active');
        }

        function goHome() { switchScreen('home'); }

        function addEnergy() {
            user.energy += 50;
            saveUser();
            alert("ENERGY RECHARGED: +50");
        }

        // --- CARD RENDER ENGINE (3D & HOLO) ---
        function createCardHTML(cardData, onClickFnStr) {
            // Ëâ≤Âà§ÂÆö
            let color = "var(--neon-cyan)";
            if(cardData.type==="ATK") color="var(--neon-pink)";
            if(cardData.type==="HEAL") color="var(--neon-green)";
            if(cardData.type==="DEF") color="var(--neon-blue)";
            
            // ÁîªÂÉè
            const imgUrl = `https://placehold.co/120x100/111/fff?text=${cardData.img}&font=roboto`;

            return `
            <div class="card-scene" onmousemove="cardTilt(event, this)" onmouseleave="cardReset(this)" onclick="${onClickFnStr}">
                <div class="card-obj rarity-${cardData.rarity}">
                    <div class="card-face" style="border-color:${color}">
                        <div class="card-cost" style="background:${color}">${cardData.cost}</div>
                        <div class="card-art">
                            <img src="${imgUrl}">
                        </div>
                        <div class="holo-layer"></div>
                        <div class="card-content">
                            <div style="font-size:0.7rem; color:${color}; font-weight:bold;">${cardData.jp}</div>
                            <div style="font-size:1.2rem; font-weight:900;">${cardData.val} <span style="font-size:0.6rem;">${cardData.type}</span></div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        // 3D Tilt Logic
        window.cardTilt = function(e, el) {
            const rect = el.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const cx = rect.width/2; 
            const cy = rect.height/2;
            const dx = (x - cx) / cx; 
            const dy = (y - cy) / cy;

            const obj = el.querySelector('.card-obj');
            const holo = el.querySelector('.holo-layer');
            
            // ÂÇæ„Åç
            obj.style.transform = `rotateY(${dx * 20}deg) rotateX(${dy * -20}deg) scale(1.1)`;
            
            // „Éõ„É≠„Ç∞„É©„É†‰ΩçÁΩÆÁßªÂãï
            holo.style.backgroundPosition = `${50 + (dx * 50)}% ${50 + (dy * 50)}%`;
            holo.style.opacity = 0.8 + (Math.abs(dx)*0.2);
        };
        window.cardReset = function(el) {
            const obj = el.querySelector('.card-obj');
            const holo = el.querySelector('.holo-layer');
            obj.style.transform = `rotateY(0) rotateX(0) scale(1)`;
            holo.style.opacity = 0.4;
        };

        // --- GACHA SYSTEM ---
        let pendingGacha = false;
        function startGacha() {
            switchScreen('gacha');
        }
        function tryOpenGacha() {
            if(user.energy < 50) return alert("NOT ENOUGH ENERGY (Need 50)");
            pendingGacha = true;
            showQuiz(openGachaSuccess);
        }
        function openGachaSuccess() {
            user.energy -= 50;
            // ÊäΩÈÅ∏
            const r = Math.random();
            let tier = 1; 
            if(r < 0.1) tier = 3; else if(r < 0.4) tier = 2;
            
            const pool = CARDS.filter(c => c.rarity === tier);
            const hit = pool[Math.floor(Math.random() * pool.length)];
            
            user.collection.push(hit.id);
            saveUser();

            // ÊºîÂá∫
            const view = document.getElementById('reward-card-view');
            view.innerHTML = createCardHTML(hit, "");
            view.firstElementChild.style.transform = "scale(1.5)";
            
            document.getElementById('modal-reward').style.display = 'flex';
        }
        function closeReward() {
            document.getElementById('modal-reward').style.display = 'none';
        }

        // --- QUIZ LOGIC ---
        function showQuiz(callback) {
            const q = QUIZZES[Math.floor(Math.random()*QUIZZES.length)];
            document.getElementById('quiz-text').innerText = q.q;
            const opts = document.getElementById('quiz-options');
            opts.innerHTML = "";
            
            q.o.forEach((txt, idx) => {
                const btn = document.createElement('div');
                btn.className = "cyber-btn";
                btn.innerText = txt;
                btn.onclick = () => {
                    if(idx === q.a) {
                        alert("CORRECT! ACCESS GRANTED.");
                        document.getElementById('modal-quiz').style.display = 'none';
                        callback();
                    } else {
                        alert("ACCESS DENIED. TRY AGAIN.");
                        document.getElementById('modal-quiz').style.display = 'none';
                    }
                };
                opts.appendChild(btn);
            });
            document.getElementById('modal-quiz').style.display = 'flex';
        }

        // --- BATTLE & PVP SYSTEM ---
        function startPvE() {
            if(user.energy < 10) return alert("Low Energy");
            user.energy -= 10; saveUser();
            initBattle(false);
        }
        function startPvP() {
            if(user.energy < 20) return alert("Low Energy");
            user.energy -= 20; saveUser();
            switchScreen('matchmaking');
            // „Éû„ÉÉ„ÉÅ„É≥„Ç∞ÊºîÂá∫
            setTimeout(() => {
                const rivals = ["KAZUYA", "NEO_CHEMIST", "ATOM_BOY", "MARIE_C"];
                const name = rivals[Math.floor(Math.random()*rivals.length)];
                initBattle(true, name);
            }, 3000);
        }

        function initBattle(isPvP, rivalName) {
            battleState.isPvP = isPvP;
            battleState.hp = 200; battleState.maxHp = 200;
            battleState.eHp = isPvP ? 300 : 500; battleState.eMaxHp = battleState.eHp;
            battleState.mana = 0;
            battleState.hand = [];
            battleState.field = null;

            // ÂêçÂâçË®≠ÂÆö
            document.getElementById('enemy-name-disp').innerText = isPvP ? `RIVAL: ${rivalName}` : "ANOMALY: DARK MATTER";
            
            switchScreen('battle');
            
            // „Éá„ÉÉ„Ç≠„Åã„ÇâÊâãÊú≠5Êûö
            for(let i=0; i<5; i++) drawCard();
            
            updateBattleUI();
            battleTurnStart();
        }

        function drawCard() {
            // ÊâÄÊåÅ„Ç´„Éº„Éâ„Åã„Çâ„É©„É≥„ÉÄ„É†„Å´
            const id = user.collection[Math.floor(Math.random()*user.collection.length)];
            const base = CARDS.find(c => c.id === id);
            battleState.hand.push({...base, uid:Math.random()}); // Unique copy
        }

        function battleTurnStart() {
            // „ÇØ„Ç§„Ç∫„Åß„Éû„Éä„ÉÅ„É£„Éº„Ç∏
            showQuiz(() => {
                battleState.mana = Math.min(battleState.maxMana, battleState.mana + 3);
                updateBattleUI();
                // PvP„Å™„ÇâÁõ∏Êâã„ÇÇË°åÂãï„Åô„Çã„Éï„É™„Çí„Åô„ÇãÔºà„Åì„Åì„Åß„ÅØÁ∞°ÊòìÂåñ„ÅÆ„Åü„ÇÅ„Éó„É¨„Ç§„É§„ÉºÊìç‰Ωú„ÅÆ„ÅøÔºâ
            });
        }

        function updateBattleUI() {
            // HP Bars
            document.getElementById('player-hp-bar').style.width = (battleState.hp/battleState.maxHp)*100 + "%";
            document.getElementById('player-hp-text').innerText = battleState.hp;
            document.getElementById('enemy-hp-bar').style.width = (battleState.eHp/battleState.eMaxHp)*100 + "%";
            document.getElementById('enemy-hp-text').innerText = battleState.eHp;

            // Mana
            const mBox = document.getElementById('mana-box'); mBox.innerHTML = "";
            for(let i=0; i<battleState.maxMana; i++){
                const d = document.createElement('div');
                d.style.width="15px"; d.style.height="20px"; d.style.border="1px solid var(--neon-cyan)";
                d.style.background = (i < battleState.mana) ? "var(--neon-cyan)" : "#111";
                d.style.transform = "skewX(-20deg)";
                mBox.appendChild(d);
            }

            // Hand
            const hCon = document.getElementById('hand-container'); hCon.innerHTML = "";
            battleState.hand.forEach((c, idx) => {
                const wrap = document.createElement('div');
                wrap.className = "hand-card-wrapper";
                // 3D„Çπ„Çø„Ç§„É´
                wrap.innerHTML = createCardHTML(c, `playCard(${idx})`);
                
                // ÂõûËª¢ÈÖçÁΩÆ
                const rot = (idx - (battleState.hand.length-1)/2) * 5;
                const ty = Math.abs(idx - (battleState.hand.length-1)/2) * 10;
                wrap.style.transform = `rotate(${rot}deg) translateY(${ty}px)`;

                if(c.cost > battleState.mana) {
                    wrap.style.filter = "grayscale(1) brightness(0.5)";
                    wrap.style.pointerEvents = "none";
                }
                hCon.appendChild(wrap);
            });
        }

        function playCard(idx) {
            const card = battleState.hand[idx];
            battleState.mana -= card.cost;
            battleState.hand.splice(idx, 1);

            // ÂåñÂ≠¶ÂèçÂøú„ÉÅ„Çß„ÉÉ„ÇØ
            let dmg = card.val;
            let msg = "";
            
            if(battleState.field) {
                const f = battleState.field;
                if((card.elm==="H" && f.elm==="O") || (card.elm==="O" && f.elm==="H")) {
                    dmg *= 2; msg = "EXPLOSION!!";
                }
                else if((card.elm==="Acid" && f.elm==="Base") || (card.elm==="Base" && f.elm==="Acid")) {
                    msg = "NEUTRALIZATION (HEAL)";
                    battleState.hp += 50;
                }
            }

            // ÊºîÂá∫
            if(msg) {
                const cm = document.getElementById('combo-msg');
                cm.innerText = msg;
                cm.style.opacity = 1;
                setTimeout(()=>cm.style.opacity=0, 1500);
            }

            // ÂäπÊûúÈÅ©Áî®
            if(card.type === "ATK") {
                battleState.eHp = Math.max(0, battleState.eHp - dmg);
                // ÊïµÊè∫„Çâ„Åó
                const eImg = document.getElementById('enemy-img');
                eImg.style.transform = "translateX(10px)";
                setTimeout(()=>eImg.style.transform="translateX(0)", 100);
            } else if(card.type === "HEAL") {
                battleState.hp = Math.min(battleState.maxHp, battleState.hp + dmg);
            } else if(card.type === "DEF") {
                battleState.hp += 20; // Á∞°Êòì„Ç∑„Éº„É´„Éâ
            }

            battleState.field = card;
            
            // „Ç´„Éº„ÉâË£úÂÖÖ
            drawCard();
            updateBattleUI();

            // ÂãùÂà©Âà§ÂÆö
            if(battleState.eHp <= 0) {
                setTimeout(()=>{
                    alert("VICTORY! RANK UP!");
                    user.wins++;
                    if(user.wins > 3) user.rank = "C";
                    saveUser();
                    goHome();
                }, 500);
                return;
            }

            // Êïµ„Çø„Éº„É≥
            setTimeout(enemyTurn, 1000);
        }

        function enemyTurn() {
            // Á∞°ÊòìÊïµAI
            const dmg = battleState.isPvP ? Math.floor(Math.random()*40)+10 : 20;
            battleState.hp = Math.max(0, battleState.hp - dmg);
            updateBattleUI();
            
            if(battleState.hp <= 0) {
                setTimeout(()=>{alert("DEFEAT..."); goHome();}, 500);
            } else {
                battleTurnStart();
            }
        }

        function showDeck() {
            alert("Current Collection: " + user.collection.length + " Cards\n(Deck Editor coming in V4.0)");
        }

    </script>
</body>
</html>