<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHEMISTRY SAGA - Premium</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-base: #080808;
            --bg-panel: rgba(20, 20, 20, 0.95);
            --gold-main: #d4af37; /* メタリックゴールド */
            --gold-dim: #755c1b;
            --text-white: #e0e0e0;
            --text-gray: #888;
            --accent-red: #800020; /* バーガンディ */
            --accent-blue: #1e3c72; /* ロイヤルブルー */
            --font-title: 'Cinzel', serif;
            --font-body: 'Lato', sans-serif;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-base);
            /* 高級感のあるダークグラデーション */
            background-image: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #000000 100%);
            font-family: var(--font-body);
            color: var(--text-white);
            height: 100dvh; width: 100vw;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- 共通パーツ --- */
        /* ヘッダー */
        .header-hud {
            height: 60px; width: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 25px;
            position: fixed; top: 0; z-index: 100;
        }
        .user-info { 
            display: flex; align-items: center; gap: 10px; 
            font-family: var(--font-title); letter-spacing: 1px; color: #888;
        }
        .energy-bar {
            padding: 5px 15px; border-radius: 50px;
            border: 1px solid var(--gold-dim);
            color: var(--gold-main); font-weight: bold; font-family: var(--font-title);
            display: flex; align-items: center; gap: 8px;
            background: rgba(0,0,0,0.5);
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.1);
        }

        /* フッター */
        .bottom-nav {
            height: 80px; width: 100%;
            background: #050505;
            display: flex; justify-content: space-around; align-items: center;
            position: fixed; bottom: 0; z-index: 100;
            border-top: 1px solid #222;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; color: #555; font-size: 0.7rem; gap: 6px; cursor: pointer; transition: 0.3s;
            font-family: var(--font-title); letter-spacing: 1px;
        }
        .nav-item.active { color: var(--gold-main); text-shadow: 0 0 8px rgba(212, 175, 55, 0.3); }
        .nav-icon { font-size: 1.4rem; }

        /* メインエリア */
        .content-area {
            flex: 1; width: 100%;
            margin-top: 60px; margin-bottom: 80px;
            position: relative; overflow: hidden;
        }
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; align-items: center;
            animation: fadeIn 0.5s ease; padding: 20px; overflow-y: auto;
        }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- タイトル --- */
        .title-logo {
            font-family: var(--font-title);
            font-size: 3rem; font-weight: 400; text-align: center; margin-top: 18vh;
            color: var(--gold-main);
            letter-spacing: 5px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            border-bottom: 1px solid var(--gold-dim);
            padding-bottom: 10px;
        }
        .title-sub {
            font-family: var(--font-title); color: #666; letter-spacing: 3px; font-size: 0.9rem; margin-top: 10px; margin-bottom: 60px;
        }

        /* --- 高級ボタン --- */
        .game-btn {
            background: transparent;
            border: 1px solid var(--gold-dim);
            color: var(--gold-main);
            padding: 15px 40px;
            font-family: var(--font-title);
            font-size: 1rem; letter-spacing: 2px;
            cursor: pointer; transition: 0.3s;
            width: 80%; max-width: 300px; margin: 10px 0;
            position: relative; overflow: hidden;
        }
        .game-btn::before {
            content: ""; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212, 175, 55, 0.2), transparent);
            transition: 0.5s;
        }
        .game-btn:hover { border-color: var(--gold-main); box-shadow: 0 0 15px rgba(212, 175, 55, 0.2); }
        .game-btn:hover::before { left: 100%; }
        .game-btn:active { transform: scale(0.98); background: rgba(212, 175, 55, 0.1); }

        .btn-fill { background: var(--gold-main); color: #000; border: none; font-weight: bold; }
        .btn-fill:hover { background: #e5c15d; box-shadow: 0 0 20px rgba(212, 175, 55, 0.4); }

        .input-field {
            background: transparent; border: none; border-bottom: 1px solid #555;
            color: white; padding: 10px; width: 80%; margin-bottom: 40px;
            font-size: 1.2rem; text-align: center; font-family: var(--font-body);
            transition: 0.3s;
        }
        .input-field:focus { outline: none; border-color: var(--gold-main); }

        /* --- バトルフィールド --- */
        .battle-container { width: 100%; height: 100%; display: flex; flex-direction: column; }
        
        .unit-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        
        /* HPバー (極細) */
        .hp-bar-wrap { width: 240px; margin-top: 10px; position: relative; }
        .hp-bar-bg { width: 100%; height: 4px; background: #333; overflow: hidden; }
        .hp-bar-fill { height: 100%; width: 100%; transition: width 0.5s ease; }
        .hp-enemy { background: var(--accent-red); box-shadow: 0 0 10px var(--accent-red); }
        .hp-player { background: var(--gold-main); box-shadow: 0 0 10px var(--gold-main); }
        .hp-text { 
            position: absolute; top: -20px; width: 100%; text-align: right; 
            font-size: 0.8rem; font-family: var(--font-title); letter-spacing: 1px;
        }

        /* マナゲージ (宝石風) */
        .mana-gauge {
            display: flex; gap: 8px; margin-top: 10px;
        }
        .mana-orb { 
            width: 8px; height: 8px; transform: rotate(45deg); 
            background: #333; border: 1px solid #555; transition: 0.4s; 
        }
        .mana-orb.active { 
            background: var(--accent-blue); border-color: #4facfe; 
            box-shadow: 0 0 10px #4facfe; 
        }

        /* 敵スキルログ */
        .skill-toast {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8); border: 1px solid var(--accent-red); color: var(--accent-red);
            padding: 15px 40px; font-family: var(--font-title); letter-spacing: 2px;
            text-align: center; z-index: 50; display: none; min-width: 200px;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            animation: fadeInOut 2s ease;
        }
        @keyframes fadeInOut { 0%{opacity:0; letter-spacing: 5px;} 20%{opacity:1; letter-spacing: 2px;} 80%{opacity:1;} 100%{opacity:0;} }

        /* カードデザイン (額縁) */
        .card-visual {
            width: 100px; height: 150px; flex-shrink: 0;
            background: #111; border: 1px solid #333;
            display: flex; flex-direction: column; align-items: center; padding: 5px;
            position: relative; transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .card-visual::before {
            content:""; position:absolute; inset: 3px; border: 1px solid #333; pointer-events: none;
        }
        .card-visual.selected { 
            transform: translateY(-20px); 
            box-shadow: 0 20px 40px rgba(0,0,0,0.8);
            border-color: var(--gold-main);
            z-index: 10;
        }
        .card-visual.selected::before { border-color: rgba(212, 175, 55, 0.3); }
        .card-visual.disabled { opacity: 0.4; filter: grayscale(1); }

        .cost-badge {
            position: absolute; top: -6px; left: -6px; width: 20px; height: 20px;
            background: #111; color: var(--accent-blue); border: 1px solid var(--accent-blue);
            display: flex; justify-content: center; align-items: center; font-size: 0.7rem; font-family: var(--font-title);
            transform: rotate(45deg); z-index: 2;
        }
        .cost-badge span { transform: rotate(-45deg); } /* 文字は戻す */

        .cv-img { 
            width: 100%; height: 70%; background: #080808; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 1.8rem; margin-bottom: 5px; 
            filter: grayscale(0.5) contrast(1.2);
        }
        .cv-name { font-size: 0.6rem; font-family: var(--font-title); letter-spacing: 1px; color: #aaa; text-align: center;}
        .cv-atk { font-size: 0.6rem; color: var(--gold-main); margin-top: auto; letter-spacing: 1px; }

        /* レアリティ別の枠色 */
        .rarity-2 { border-color: #555; }
        .rarity-3 { border-color: var(--gold-dim); }
        .rarity-3 .cv-img { color: var(--gold-main); filter: none; }

        /* 手札エリア */
        .hand-scroll {
            height: 180px; width: 100%; display: flex; align-items: center; gap: 15px;
            overflow-x: auto; padding: 0 25px; 
            border-top: 1px solid #222;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        }

        /* アクションボタン群 */
        .action-row {
            display: flex; gap: 15px; width: 100%; justify-content: center; position: absolute; bottom: 20px;
        }
        .btn-small { width: auto; padding: 10px 25px; margin: 0; font-size: 0.8rem; }

        /* --- リザルト画面 --- */
        #screen-result {
            background: rgba(0,0,0,0.95); z-index: 200; justify-content: center;
        }
        .result-title {
            font-family: var(--font-title); font-size: 2.5rem; color: var(--gold-main);
            margin-bottom: 20px; letter-spacing: 5px;
            animation: fadeInUp 0.8s ease;
        }
        .reward-box {
            font-size: 1.2rem; color: #aaa; display: flex; flex-direction: column; align-items: center; gap: 10px;
            margin-bottom: 60px; font-family: var(--font-title);
        }
        .count-up { font-size: 3rem; color: var(--text-white); }
        @keyframes fadeInUp { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }

        /* モーダル */
        .modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9);
            display: none; justify-content: center; align-items: center; z-index: 300; backdrop-filter: blur(8px);
        }
        .modal-box {
            background: #111; width: 90%; max-width: 400px; 
            padding: 40px 30px; text-align: center; border: 1px solid #333; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        }
        .modal-title { font-family: var(--font-title); color: var(--gold-main); letter-spacing: 2px; margin-bottom: 20px; }

        /* エフェクト */
        .shake { animation: shake 0.4s; }
        @keyframes shake { 0%,100%{transform:translateX(0);} 25%{transform:translateX(-5px);} 75%{transform:translateX(5px);} }
        .float-damage {
            position: absolute; font-size: 2rem; color: var(--text-white); font-family: var(--font-title); 
            text-shadow: 0 0 10px var(--accent-red); animation: floatUp 1.2s forwards; z-index: 50;
        }
        @keyframes floatUp { to { transform: translateY(-60px); opacity: 0; letter-spacing: 5px;} }

        /* ガチャ箱 */
        .mystery-box {
            width: 150px; height: 150px; border: 1px solid var(--gold-dim);
            display: flex; justify-content: center; align-items: center;
            font-size: 3rem; color: var(--gold-dim); margin-bottom: 20px;
            cursor: pointer; transition: 0.5s;
            background: radial-gradient(circle, #222, #000);
        }
        .mystery-box:hover { border-color: var(--gold-main); color: var(--gold-main); box-shadow: 0 0 30px rgba(212, 175, 55, 0.1); }

    </style>
</head>
<body>

    <header class="header-hud" id="hud" style="display: none;">
        <div class="user-info">
            <span style="font-size:1.2rem;">◇</span> <span id="header-username">GUEST</span>
        </div>
        <div class="energy-bar">
            ⚡ <span id="energy-val">0</span>
        </div>
    </header>

    <main class="content-area">

        <div id="screen-login" class="screen active" style="justify-content:center;">
            <div class="title-logo">CHEMISTRY<br>SAGA</div>
            <div class="title-sub">PREMIUM EDITION</div>
            
            <input type="text" id="login-name" class="input-field" placeholder="ENTER NAME">
            <button class="game-btn" onclick="login()">START GAME</button>
        </div>

        <div id="screen-home" class="screen">
            <h2 style="font-family:var(--font-title); font-weight:400; letter-spacing:3px; color:var(--gold-dim); border-bottom:1px solid #222; width:100%; padding-bottom:10px;">DASHBOARD</h2>
            
            <div style="width:100%; padding:30px; border:1px solid #222; margin-bottom:20px; display:flex; gap:20px; align-items:center; background:linear-gradient(45deg, #111, #080808);">
                <div style="font-size:2.5rem; color:var(--gold-main);">♔</div>
                <div>
                    <div style="font-size:0.7rem; color:#666; letter-spacing:1px;">CURRENT CLASS</div>
                    <div style="font-size:1.2rem; font-family:var(--font-title); letter-spacing:1px;">NOVICE ALCHEMIST</div>
                </div>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; width:100%;">
                <div style="border:1px solid #222; padding:20px; text-align:center;">
                    <div style="font-size:1.5rem; margin-bottom:10px; opacity:0.5;">❖</div>
                    <h3 style="margin:0; font-size:0.8rem; color:#666;">COLLECTION</h3>
                    <div id="card-count" style="font-size:1.5rem; font-family:var(--font-title); margin-top:5px;">0</div>
                </div>
                <div style="border:1px solid #222; padding:20px; text-align:center;">
                    <div style="font-size:1.5rem; margin-bottom:10px; opacity:0.5;">⚔</div>
                    <h3 style="margin:0; font-size:0.8rem; color:#666;">VICTORIES</h3>
                    <div style="font-size:1.5rem; font-family:var(--font-title); margin-top:5px;">--</div>
                </div>
            </div>
            
            <div style="margin-top:auto; padding:20px; font-size:0.8rem; color:#444; text-align:center; font-family:var(--font-title);">
                Tap [CHARGE] in battle to gain mana.
            </div>
        </div>

        <div id="screen-battle" class="screen" style="padding:0;">
            <div class="battle-container">
                
                <div class="unit-area">
                    <div id="enemy-visual" class="card-visual rarity-3" style="transform:scale(0.9); border-color:var(--accent-red);">
                        <div class="cv-img" style="color:var(--accent-red);">IV</div>
                        <div class="cv-name">TARGET</div>
                    </div>
                    <div style="font-family:var(--font-title); margin-top:10px; letter-spacing:2px; font-size:0.8rem;">SULFURIC ACID</div>
                    
                    <div class="hp-bar-wrap">
                        <div class="hp-text"><span id="enemy-hp-text">200</span> / 200</div>
                        <div class="hp-bar-bg"><div id="enemy-hp-bar" class="hp-bar-fill hp-enemy"></div></div>
                    </div>
                    <div id="enemy-toast" class="skill-toast"></div>
                </div>

                <div class="unit-area">
                    <div id="active-slot" style="width:100px; height:150px; border:1px solid #333; display:flex; justify-content:center; align-items:center; color:#333; font-family:var(--font-title); font-size:0.8rem; margin-bottom:20px;">
                        SELECT
                    </div>
                    
                    <div class="action-row">
                        <button class="game-btn btn-small" onclick="openChargeQuiz()" style="border-color:var(--accent-blue); color:var(--accent-blue);">
                            CHARGE
                        </button>
                        <button id="attack-btn" class="game-btn btn-small btn-fill" onclick="playerAttack()" style="display:none;">
                            ATTACK
                        </button>
                    </div>
                </div>

                <div class="unit-area" style="justify-content:flex-end; padding-bottom:10px;">
                    <div style="display:flex; justify-content:space-between; width:100%; padding:0 30px; align-items:flex-end; margin-bottom:10px;">
                        <div class="hp-bar-wrap" style="width:140px;">
                            <div class="hp-text" style="text-align:left;">PLAYER</div>
                            <div class="hp-bar-bg"><div id="player-hp-bar" class="hp-bar-fill hp-player"></div></div>
                            <div style="font-size:0.7rem; color:#666; margin-top:3px;"><span id="player-hp-text">100</span></div>
                        </div>
                        <div>
                            <div style="font-size:0.6rem; letter-spacing:1px; color:#666; text-align:right;">MANA</div>
                            <div class="mana-gauge" id="mana-gauge">
                                </div>
                        </div>
                    </div>
                    
                    <div class="hand-scroll" id="hand-container">
                        </div>
                </div>
            </div>
        </div>
        
        <div id="screen-result" class="screen">
            <div class="result-title">VICTORY</div>
            <div class="reward-box">
                REWARD
                <span class="count-up" id="result-energy">0</span> 
                <span style="font-size:1rem; color:var(--gold-dim)">ENERGY</span>
            </div>
            <button class="game-btn" onclick="finishBattle()">RETURN</button>
        </div>

        <div id="screen-gameover" class="screen" style="background:rgba(20,0,0,0.95); z-index:200; justify-content:center;">
            <h1 style="color:var(--accent-red); font-family:var(--font-title); letter-spacing:5px; font-weight:400; font-size:2.5rem;">DEFEATED</h1>
            <p style="color:#666; margin-bottom:40px; font-family:var(--font-title);">MISSION FAILED</p>
            <button class="game-btn" onclick="finishBattle()" style="border-color:var(--accent-red); color:var(--accent-red);">RETURN</button>
        </div>

        <div id="screen-gacha" class="screen">
            <h2 class="modal-title">MATERIALIZE</h2>
            <div style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                
                <div class="mystery-box" onclick="tryGacha()">
                    ❖
                </div>
                
                <div style="margin-top:30px; color:#666; font-family:var(--font-title); letter-spacing:2px;">
                    COST: 300 <span style="font-size:0.8rem">ENERGY</span>
                </div>
            </div>
        </div>

    </main>

    <nav class="bottom-nav" id="bottom-nav" style="display:none;">
        <div class="nav-item active" onclick="navTo('home')"><div class="nav-icon">❖</div>HOME</div>
        <div class="nav-item" onclick="initBattle()"><div class="nav-icon">⚔</div>BATTLE</div>
        <div class="nav-item" onclick="navTo('gacha')"><div class="nav-icon">⟡</div>GACHA</div>
    </nav>

    <div id="quiz-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title">MANA CHARGE</h3>
            <p id="q-text" style="margin:30px 0; font-family:var(--font-body); line-height:1.6;"></p>
            <div id="q-options" style="display:flex; flex-direction:column; gap:15px;"></div>
        </div>
    </div>

    <div id="card-modal" class="modal-overlay">
        <div class="modal-box">
            <h2 class="modal-title">ACQUIRED</h2>
            <div id="new-card-view" style="display:flex; justify-content:center; margin:30px 0;"></div>
            <button class="game-btn" onclick="closeModal('card-modal')">ACCEPT</button>
        </div>
    </div>

    <script>
        // --- 1. データ ---
        const cards = [
            {id:1, name:"水素", atk:30, cost:1, rarity:1, img:"H₂"},
            {id:2, name:"黒鉛", atk:30, cost:1, rarity:1, img:"C"},
            {id:3, name:"塩酸", atk:50, cost:2, rarity:2, img:"HCl"},
            {id:4, name:"アンモニア", atk:45, cost:2, rarity:2, img:"NH₃"},
            {id:5, name:"ベンゼン", atk:80, cost:3, rarity:3, img:"C₆H₆"},
            {id:6, name:"王水", atk:100, cost:3, rarity:3, img:"Au溶"}
        ];
        const enemySkills = [
            {name:"脱水作用", atk:20}, {name:"溶解熱", atk:30}, {name:"酸化作用", atk:40}
        ];
        const quizList = [
            {q:"原子番号1番は？", a:0, o:["水素","ヘリウム","リチウム"]},
            {q:"Naの炎色反応は？", a:1, o:["赤","黄","緑"]},
            {q:"腐卵臭がするのは？", a:0, o:["硫化水素","酸素","窒素"]},
            {q:"ダイヤモンドの同素体は？", a:2, o:["水晶","ガラス","黒鉛"]}
        ];

        // --- 2. 変数 ---
        let user = null;
        let myCards = [];
        let energy = 500;
        
        let enemyMaxHp = 200;
        let enemyHp = 200;
        let playerMaxHp = 100;
        let playerHp = 100;
        let playerMana = 0;
        const maxMana = 5;
        let selectedCard = null;
        let isTurn = false;

        // --- 3. システム ---
        function login() {
            const name = document.getElementById('login-name').value;
            if(!name) return;
            user = name;
            const saved = localStorage.getItem('chemSaga_'+user);
            if(saved) {
                const d = JSON.parse(saved);
                myCards = d.cards; energy = d.energy;
            } else {
                myCards = [cards[0], cards[1]];
                saveData();
            }
            document.getElementById('header-username').innerText = user.toUpperCase();
            updateGlobalUI();
            
            document.getElementById('hud').style.display = 'flex';
            document.getElementById('bottom-nav').style.display = 'flex';
            navTo('home');
        }

        function saveData() {
            if(!user) return;
            localStorage.setItem('chemSaga_'+user, JSON.stringify({cards:myCards, energy:energy}));
        }

        function updateGlobalUI() {
            document.getElementById('energy-val').innerText = energy;
            document.getElementById('card-count').innerText = myCards.length;
        }

        function navTo(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-'+screenId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if(screenId === 'home') document.querySelectorAll('.nav-item')[0].classList.add('active');
            if(screenId === 'battle') document.querySelectorAll('.nav-item')[1].classList.add('active');
            if(screenId === 'gacha') document.querySelectorAll('.nav-item')[2].classList.add('active');
        }

        // --- 4. バトル ---
        function initBattle() {
            navTo('battle');
            enemyHp = enemyMaxHp;
            playerHp = playerMaxHp;
            playerMana = 0;
            selectedCard = null;
            isTurn = true;
            
            updateBattleUI();
            document.getElementById('active-slot').innerHTML = "SELECT";
            document.getElementById('attack-btn').style.display = 'none';
        }

        function updateBattleUI() {
            const epct = (enemyHp / enemyMaxHp) * 100;
            document.getElementById('enemy-hp-bar').style.width = epct + "%";
            document.getElementById('enemy-hp-text').innerText = enemyHp;
            
            const ppct = (playerHp / playerMaxHp) * 100;
            document.getElementById('player-hp-bar').style.width = ppct + "%";
            document.getElementById('player-hp-text').innerText = playerHp;

            const mBox = document.getElementById('mana-gauge');
            mBox.innerHTML = "";
            for(let i=0; i<maxMana; i++) {
                const d = document.createElement('div');
                d.className = `mana-orb ${i < playerMana ? 'active' : ''}`;
                mBox.appendChild(d);
            }
            renderHand();
        }

        function renderHand() {
            const el = document.getElementById('hand-container');
            el.innerHTML = "";
            myCards.slice().reverse().forEach(c => {
                const div = document.createElement('div');
                div.className = `card-visual rarity-${c.rarity}`;
                if(c.cost > playerMana) div.classList.add('disabled');
                div.innerHTML = `
                    <div class="cost-badge"><span>${c.cost}</span></div>
                    <div class="cv-img">${c.img}</div>
                    <div class="cv-name">${c.name}</div>
                    <div class="cv-atk">${c.atk}</div>
                `;
                div.onclick = () => selectCard(c, div);
                el.appendChild(div);
            });
        }

        function selectCard(c, div) {
            if(!isTurn) return;
            if(c.cost > playerMana) return alert("Insufficient Mana");

            document.querySelectorAll('.card-visual').forEach(d => d.classList.remove('selected'));
            div.classList.add('selected');
            selectedCard = c;
            
            document.getElementById('active-slot').innerHTML = div.outerHTML;
            document.getElementById('active-slot').children[0].classList.remove('selected', 'disabled');
            document.getElementById('attack-btn').style.display = 'block';
        }

        function openChargeQuiz() {
            if(!isTurn) return;
            if(playerMana >= maxMana) return alert("Mana Full");
            
            const q = quizList[Math.floor(Math.random()*quizList.length)];
            document.getElementById('q-text').innerText = q.q;
            const opts = document.getElementById('q-options');
            opts.innerHTML = "";
            q.o.forEach((txt, i) => {
                const b = document.createElement('button');
                b.className = "game-btn"; b.style.width="100%"; b.innerText=txt;
                b.onclick = () => {
                    document.getElementById('quiz-modal').style.display = 'none';
                    if(i === q.a) {
                        playerMana = Math.min(maxMana, playerMana + 2);
                        alert("Charge Successful (+2)");
                        updateBattleUI();
                    } else {
                        alert("Charge Failed");
                    }
                };
                opts.appendChild(b);
            });
            document.getElementById('quiz-modal').style.display = 'flex';
        }

        function playerAttack() {
            if(!isTurn || !selectedCard) return;
            playerMana -= selectedCard.cost;
            isTurn = false;
            document.getElementById('attack-btn').style.display = 'none';
            updateBattleUI();

            const dmg = selectedCard.atk;
            enemyHp = Math.max(0, enemyHp - dmg);
            updateBattleUI();
            
            showDamage(dmg, 'enemy-visual');
            document.getElementById('enemy-visual').classList.add('shake');
            setTimeout(()=>document.getElementById('enemy-visual').classList.remove('shake'), 400);

            if(enemyHp <= 0) setTimeout(showWinResult, 1000);
            else setTimeout(cpuTurn, 1500);
        }

        function cpuTurn() {
            const skill = enemySkills[Math.floor(Math.random()*enemySkills.length)];
            const dmg = skill.atk;
            
            const toast = document.getElementById('enemy-toast');
            toast.innerHTML = `${skill.name}<br><span style="font-size:0.8rem">DAMAGE ${dmg}</span>`;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
                playerHp = Math.max(0, playerHp - dmg);
                updateBattleUI();
                
                document.body.style.transform = "translateX(-5px)";
                setTimeout(() => document.body.style.transform = "none", 100);

                if(playerHp <= 0) navTo('gameover');
                else isTurn = true;
            }, 1500);
        }

        function showWinResult() {
            navTo('result');
            const el = document.getElementById('result-energy');
            let current = 0;
            const reward = 200;
            const timer = setInterval(() => {
                current += 10; el.innerText = current;
                if(current >= reward) clearInterval(timer);
            }, 20);
            energy += reward; saveData(); updateGlobalUI();
        }
        function finishBattle() { navTo('home'); }

        function showDamage(val, targetId) {
            const t = document.getElementById(targetId);
            const r = t.getBoundingClientRect();
            const d = document.createElement('div');
            d.className = 'float-damage';
            d.innerText = val;
            d.style.left = (r.left + r.width/2) + "px";
            d.style.top = r.top + "px";
            document.body.appendChild(d);
            setTimeout(()=>d.remove(), 1000);
        }

        function tryGacha() {
            if(energy < 300) return alert("Insufficient Energy");
            energy -= 300; updateGlobalUI(); saveData();
            
            const r = Math.random();
            let rarity = 1; if(r<0.2) rarity=3; else if(r<0.5) rarity=2;
            const hit = cards.filter(c=>c.rarity===rarity)[0];
            myCards.push(hit); saveData(); updateGlobalUI();

            const v = document.createElement('div');
            v.className = `card-visual rarity-${hit.rarity}`;
            v.style.transform = "scale(1.2)";
            v.innerHTML = `<div class="cv-img">${hit.img}</div><div class="cv-name">${hit.name}</div>`;
            
            document.getElementById('new-card-view').innerHTML = "";
            document.getElementById('new-card-view').appendChild(v);
            document.getElementById('card-modal').style.display = 'flex';
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    </script>
</body>
</html>