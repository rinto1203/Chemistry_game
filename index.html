<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHEMISTRY TCG</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@500;800&family=Chakra+Petch:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* --- ãƒ¢ãƒ€ãƒ³ãªã‚²ãƒ¼ãƒ UIã‚«ãƒ©ãƒ¼ --- */
            --bg-color: #f0f2f5;
            --panel-color: #ffffff;
            --primary: #3b82f6; /* é®®ã‚„ã‹ãªé’ */
            --accent: #f59e0b;  /* é»„è‰²ï¼ˆé›»æ°—ãƒ»å¼·èª¿ï¼‰ */
            --danger: #ef4444;  /* èµ¤ï¼ˆHPãƒ»æ•µï¼‰ */
            --text-main: #1f2937;
            --text-sub: #6b7280;

            /* --- ãƒ•ã‚©ãƒ³ãƒˆå®šç¾© --- */
            --font-main: 'M PLUS Rounded 1c', sans-serif;
            --font-digit: 'Chakra Petch', sans-serif;

            /* --- ã‚«ãƒ¼ãƒ‰å±æ€§ã‚«ãƒ©ãƒ¼ --- */
            --type-fire: #ff5252;
            --type-water: #448aff;
            --type-grass: #00c853;
            --type-lightning: #ffd600;
            --type-metal: #78909c;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            /* æ˜ã‚‹ã„ãƒ‡ã‚¸ã‚¿ãƒ«ã‚°ãƒªãƒƒãƒ‰èƒŒæ™¯ */
            background-image: 
                linear-gradient(rgba(59, 130, 246, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(59, 130, 246, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            font-family: var(--font-main);
            color: var(--text-main);
            height: 100dvh; width: 100vw;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- å…±é€šãƒ‘ãƒ¼ãƒ„ --- */
        .header-hud {
            height: 60px; width: 100%;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; position: fixed; top: 0; z-index: 100;
            border-bottom: 1px solid #e5e7eb; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .user-info { display: flex; align-items: center; gap: 10px; font-weight: bold; color: var(--text-main); }
        .energy-bar {
            background: #e0f2fe; padding: 6px 16px; border-radius: 20px;
            color: var(--primary); font-weight: bold; display: flex; align-items: center; gap: 5px;
            border: 1px solid var(--primary);
        }

        .bottom-nav {
            height: 70px; width: 100%; background: #ffffff;
            display: flex; justify-content: space-around; align-items: center;
            position: fixed; bottom: 0; z-index: 100;
            border-top: 1px solid #e5e7eb; padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-sub); font-size: 0.7rem; gap: 4px; cursor: pointer; transition: 0.2s;
            font-weight: bold;
        }
        .nav-item.active { color: var(--primary); transform: translateY(-2px); }
        .nav-icon { font-size: 1.5rem; }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; align-items: center;
            padding: 20px; padding-top: 80px; padding-bottom: 90px; overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }

        /* ãƒœã‚¿ãƒ³ (ãƒ¢ãƒ€ãƒ³) */
        .game-btn {
            background: var(--primary); border: none; color: white;
            padding: 14px 40px; font-weight: bold; font-size: 1rem; border-radius: 30px;
            cursor: pointer; transition: 0.2s; width: 80%; max-width: 300px; margin: 10px 0;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }
        .game-btn:active { transform: scale(0.98); }
        .btn-yellow { background: var(--accent); box-shadow: 0 4px 10px rgba(245, 158, 11, 0.3); }
        .btn-red { background: var(--danger); box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3); }
        
        .input-field { 
            background: #fff; border: 2px solid #e5e7eb; color: var(--text-main); 
            padding: 12px; width: 80%; margin-bottom: 30px; font-size: 1.1rem; 
            text-align: center; border-radius: 10px; 
        }
        .input-field:focus { border-color: var(--primary); outline: none; }

        /* --- â˜…æœ€é‡è¦ï¼šãƒã‚±ã‚«é¢¨ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
        .pokeca-card {
            width: 160px; height: 220px; flex-shrink: 0;
            border-radius: 12px;
            /* å±æ€§è‰²ã§æ ç·šã‚’å¤‰åŒ–ã•ã›ã‚‹ */
            border: 4px solid #ccc; background: #fff;
            display: flex; flex-direction: column;
            position: relative; overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            color: #333;
        }
        /* å±æ€§åˆ¥ã®è‰²å®šç¾© */
        .type-fire { border-color: var(--type-fire); background: linear-gradient(135deg, #fff, #ffebee); }
        .type-water { border-color: var(--type-water); background: linear-gradient(135deg, #fff, #e3f2fd); }
        .type-grass { border-color: var(--type-grass); background: linear-gradient(135deg, #fff, #e8f5e9); }
        .type-lightning { border-color: var(--type-lightning); background: linear-gradient(135deg, #fff, #fffde7); }
        .type-metal { border-color: var(--type-metal); background: linear-gradient(135deg, #fff, #eceff1); }

        /* ã‚­ãƒ©ã‚­ãƒ©åŠ å·¥ (æœ€é«˜ãƒ¬ã‚¢ãƒªãƒ†ã‚£ç”¨ - æ–œã‚ã«å…‰ãŒèµ°ã‚‹) */
        .rarity-3 { box-shadow: 0 5px 15px rgba(245, 158, 11, 0.3); }
        .rarity-3::after {
            content: ""; position: absolute; top: -100%; left: -100%; width: 300%; height: 300%;
            background: linear-gradient(115deg, transparent 30%, rgba(255,255,255,0.8) 45%, rgba(255,255,255,0.0) 50%, rgba(255,255,0,0.3) 55%, transparent 70%);
            background-size: 200% 200%; animation: foilShine 4s infinite linear;
            pointer-events: none; mix-blend-mode: overlay; opacity: 0.8;
        }
        @keyframes foilShine { 0%{transform: translate(0,0);} 100%{transform: translate(100px, 100px);} }

        /* ã‚«ãƒ¼ãƒ‰ã®æ§‹é€  */
        .pc-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 6px 10px; font-weight: 900; font-size: 1rem;
        }
        .pc-hp { color: var(--danger); font-family: var(--font-digit); }
        
        .pc-image-box {
            width: 92%; height: 90px; margin: 0 auto;
            border: 2px solid rgba(0,0,0,0.1); box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
            display: flex; justify-content: center; align-items: center;
            background: #f9fafb; overflow: hidden; font-size: 3rem; border-radius: 4px;
        }

        .pc-body { flex: 1; padding: 10px; display: flex; flex-direction: column; }
        
        .pc-move {
            display: flex; align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 6px; margin-bottom: 6px;
        }
        .pc-cost { display: flex; gap: 2px; margin-right: 10px; }
        .cost-orb {
            width: 14px; height: 14px; border-radius: 50%; background: #ddd;
            box-shadow: inset 0 0 3px rgba(0,0,0,0.2);
        }
        .cost-orb.filled { background: var(--accent); box-shadow: 0 0 5px var(--accent); }
        
        .pc-move-name { font-weight: 900; font-size: 1rem; flex: 1; }
        .pc-damage { font-size: 1.4rem; font-weight: 900; font-family: var(--font-digit); }
        
        .pc-desc {
            font-size: 0.65rem; color: var(--text-sub); line-height: 1.3;
            margin-top: auto; border: 1px solid rgba(0,0,0,0.1); padding: 4px; border-radius: 4px; background: rgba(255,255,255,0.5);
        }

        /* æ‰‹æœ­ã§ã®æŒ™å‹• */
        .pokeca-card.in-hand { box-shadow: 0 -5px 15px rgba(0,0,0,0.1); }
        .pokeca-card.in-hand:hover {
            transform: translateY(-50px) scale(1.25) !important; z-index: 100;
        }
        .pokeca-card.selected {
            transform: translateY(-30px) scale(1.1) !important; z-index: 50;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4); border-color: var(--primary);
        }
        .pokeca-card.disabled { filter: grayscale(1) opacity(0.6); }

        /* --- ãƒãƒˆãƒ«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ (ãƒ¢ãƒ€ãƒ³åŒ–) --- */
        .battle-container { width: 100%; height: 100%; display: flex; flex-direction: column; }
        .unit-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        
        /* æ•µã‚¨ãƒªã‚¢ */
        .boss-card-modern {
            width: 140px; height: 180px; background: #1f2937; border: 4px solid var(--danger);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 12px; color: white; box-shadow: 0 5px 20px rgba(239, 68, 68, 0.4);
        }
        
        /* HPãƒãƒ¼ (ãƒ¢ãƒ€ãƒ³) */
        .hp-bar-wrap { width: 240px; margin-top: 10px; }
        .hp-bar-bg { width: 100%; height: 10px; background: #e5e7eb; border-radius: 5px; overflow: hidden; }
        .hp-bar-fill { height: 100%; width: 100%; transition: width 0.5s ease; border-radius: 5px; }
        .hp-enemy { background: var(--danger); }
        .hp-player { background: var(--type-grass); }
        .hp-text { text-align: right; font-size: 0.9rem; font-weight: bold; font-family: var(--font-digit); margin-bottom: 4px; }

        /* ãƒãƒŠã‚²ãƒ¼ã‚¸ (ã‚¨ãƒãƒ«ã‚®ãƒ¼ãƒãƒ¼ã‚¯) */
        .mana-gauge { display: flex; gap: 5px; margin-top: 10px; background: #fff; padding: 5px 10px; border-radius: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .mana-icon { 
            width: 20px; height: 20px; background: #e5e7eb; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; color: #999; font-size: 0.8rem;
            transition: 0.3s;
        }
        .mana-icon.active { background: var(--accent); color: white; box-shadow: 0 0 5px var(--accent); }

        /* æ‰‹æœ­ã‚¨ãƒªã‚¢ */
        .hand-scroll {
            height: 250px; width: 100%; display: flex; align-items: center; gap: -20px; /* ã‚«ãƒ¼ãƒ‰ã‚’é‡ã­ã‚‹ */
            overflow-x: visible; padding: 0 40px; 
            position: relative; z-index: 50;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« (ãƒ¢ãƒ€ãƒ³) */
        .modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7);
            display: none; justify-content: center; align-items: center; z-index: 300; backdrop-filter: blur(5px);
        }
        .modal-box {
            background: #fff; width: 90%; max-width: 380px; padding: 30px; 
            text-align: center; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal-title { color: var(--text-main); margin-bottom: 20px; font-weight: 900; font-size: 1.4rem; }

    </style>
</head>
<body>

    <header class="header-hud" id="hud" style="display: none;">
        <div class="user-info">
            <div style="width:30px; height:30px; background:var(--primary); border-radius:50%; display:flex; justify-content:center; align-items:center; color:white;">ğŸ‘¤</div>
            <span id="header-username">GUEST</span>
        </div>
        <div class="energy-bar">âš¡ ã‚¨ãƒŠã‚¸ãƒ¼ <span id="energy-val" style="font-family:var(--font-digit); margin-left:5px;">0</span></div>
    </header>

    <div id="screen-login" class="screen active" style="justify-content:center;">
        <h1 style="font-size:2.5rem; font-weight:900; color:var(--primary);">CHEMISTRY TCG</h1>
        <p style="color:var(--text-sub); margin-bottom:40px; font-weight:bold;">ã‚µã‚¤ã‚¨ãƒ³ã‚¹ã‚«ãƒ¼ãƒ‰ãƒãƒˆãƒ«</p>
        <input type="text" id="login-name" class="input-field" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å">
        <button class="game-btn" onclick="login()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>

    <div id="screen-home" class="screen">
        <h2 style="width:100%; font-weight:900; color:var(--text-main);">ãƒ›ãƒ¼ãƒ </h2>
        
        <div style="width:100%; background:white; padding:25px; border-radius:16px; box-shadow:0 5px 15px rgba(0,0,0,0.05); display:flex; align-items:center; gap:20px; margin-bottom:30px;">
            <div style="font-size:3rem;">ğŸ“</div>
            <div>
                <div style="font-size:0.9rem; color:var(--text-sub); font-weight:bold;">ç¾åœ¨ã®ãƒ©ãƒ³ã‚¯</div>
                <div style="font-size:1.5rem; font-weight:900; color:var(--primary);">ãƒ“ã‚®ãƒŠãƒ¼ç ”ç©¶å“¡</div>
            </div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; width:100%;">
            <div style="background:white; padding:20px; border-radius:12px; text-align:center; box-shadow:0 2px 10px rgba(0,0,0,0.05);">
                <div style="font-size:2rem;">ğŸ´</div>
                <h3 style="margin:5px 0; font-size:0.9rem; color:var(--text-sub);">æ‰€æŒã‚«ãƒ¼ãƒ‰</h3>
                <div id="card-count" style="font-size:1.8rem; font-weight:900; font-family:var(--font-digit);">0</div>
            </div>
             <div style="background:white; padding:20px; border-radius:12px; text-align:center; box-shadow:0 2px 10px rgba(0,0,0,0.05);">
                <div style="font-size:2rem;">ğŸ†</div>
                <h3 style="margin:5px 0; font-size:0.9rem; color:var(--text-sub);">å‹åˆ©æ•°</h3>
                <div style="font-size:1.8rem; font-weight:900; font-family:var(--font-digit);">0</div>
            </div>
        </div>
    </div>

    <div id="screen-battle" class="screen" style="padding:0; padding-top:60px; padding-bottom:70px;">
        <div class="battle-container">
            <div class="unit-area" style="background:#f8fafc; border-bottom:2px solid #e5e7eb;">
                <div class="boss-card-modern">
                    <div style="font-size:4rem;">ğŸ‘¹</div>
                    <div style="font-weight:bold; margin-top:10px;">BOSS: æ¿ƒç¡«é…¸</div>
                </div>
                <div class="hp-bar-wrap">
                    <div class="hp-text"><span id="enemy-hp-text">200</span> / 200</div>
                    <div class="hp-bar-bg"><div id="enemy-hp-bar" class="hp-bar-fill hp-enemy"></div></div>
                </div>
            </div>

            <div class="unit-area">
                <div id="active-slot" style="width:140px; height:200px; border:3px dashed #cbd5e1; border-radius:12px; display:flex; justify-content:center; align-items:center; color:#9ca3af; font-weight:bold; margin-bottom:20px; background:rgba(255,255,255,0.5);">
                    ã‚«ãƒ¼ãƒ‰ã‚’ã‚»ãƒƒãƒˆ
                </div>
                <div style="display:flex; gap:15px;">
                    <button class="game-btn btn-yellow" onclick="openChargeQuiz()" style="width:auto; padding:12px 30px;">âš¡ ãƒãƒ£ãƒ¼ã‚¸</button>
                    <button id="attack-btn" class="game-btn" onclick="playerAttack()" style="width:auto; padding:12px 30px; display:none;">âš”ï¸ æ”»æ’ƒé–‹å§‹</button>
                </div>
            </div>

            <div class="unit-area" style="justify-content:flex-end;">
                <div style="display:flex; justify-content:space-between; width:100%; padding:0 25px; align-items:flex-end; margin-bottom:15px; z-index:60;">
                    <div class="hp-bar-wrap" style="width:140px;">
                        <div class="hp-text" style="text-align:left;">PLAYER</div>
                        <div class="hp-bar-bg"><div id="player-hp-bar" class="hp-bar-fill hp-player"></div></div>
                        <div style="font-size:0.8rem; color:var(--text-sub); margin-top:3px; font-weight:bold;"><span id="player-hp-text" style="font-family:var(--font-digit);">100</span> / 100</div>
                    </div>
                    <div>
                        <div style="font-size:0.7rem; font-weight:bold; color:var(--text-sub); text-align:right;">ã‚¨ãƒŠã‚¸ãƒ¼</div>
                        <div class="mana-gauge" id="mana-gauge"></div>
                    </div>
                </div>
                <div class="hand-scroll" id="hand-container">
                    </div>
            </div>
        </div>
    </div>

    <div id="screen-gacha" class="screen" style="justify-content:center;">
        <h2 class="modal-title">ã‚«ãƒ¼ãƒ‰ãƒ‘ãƒƒã‚¯é–‹å°</h2>
        <div style="width:220px; height:320px; background:linear-gradient(135deg, #3b82f6, #2563eb); border-radius:16px; display:flex; justify-content:center; align-items:center; font-size:4rem; color:white; cursor:pointer; box-shadow:0 10px 30px rgba(59, 130, 246, 0.4); position:relative; overflow:hidden;" onclick="tryGacha()">
            <div style="position:absolute; top:-20px; left:-20px; width:100px; height:100px; background:rgba(255,255,255,0.2); border-radius:50%;"></div>
            ğŸ´
        </div>
        <div style="margin-top:30px; font-weight:bold; color:var(--text-sub); background:white; padding:10px 20px; border-radius:20px;">
            æ¶ˆè²»ã‚¨ãƒŠã‚¸ãƒ¼: <span style="font-family:var(--font-digit); font-size:1.2rem; color:var(--accent);">300</span> âš¡
        </div>
    </div>

    <nav class="bottom-nav" id="bottom-nav" style="display:none;">
        <div class="nav-item active" onclick="navTo('home')"><div class="nav-icon">ğŸ </div>ãƒ›ãƒ¼ãƒ </div>
        <div class="nav-item" onclick="initBattle()"><div class="nav-icon">âš”ï¸</div>ãƒãƒˆãƒ«</div>
        <div class="nav-item" onclick="navTo('gacha')"><div class="nav-icon">ğŸ›ï¸</div>ã‚·ãƒ§ãƒƒãƒ—</div>
    </nav>

    <div id="quiz-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title">ã‚¨ãƒŠã‚¸ãƒ¼ãƒãƒ£ãƒ¼ã‚¸</h3>
            <p id="q-text" style="margin:30px 0; font-weight:bold; line-height:1.6; font-size:1.1rem;"></p>
            <div id="q-options" style="display:flex; flex-direction:column; gap:15px;"></div>
        </div>
    </div>

    <div id="card-modal" class="modal-overlay">
        <div class="modal-box" style="background:transparent; box-shadow:none;">
            <h2 class="modal-title" style="color:white; text-shadow:0 2px 10px rgba(0,0,0,0.5);">NEW CARD!</h2>
            <div id="new-card-view" style="display:flex; justify-content:center; margin:30px 0;"></div>
            <button class="game-btn" onclick="closeModal('card-modal')">OK</button>
        </div>
    </div>

    <script>
        // --- ãƒ‡ãƒ¼ã‚¿ (å±æ€§typeã‚’è¿½åŠ ) ---
        const cards = [
            {id:1, name:"æ°´ç´ ", type:"fire", val:30, cost:1, rarity:1, img:"Hâ‚‚", desc:"æœ€ã‚‚è»½ã„å…ƒç´ ã€‚ç‡ƒãˆã‚„ã™ã„æ°—ä½“ã€‚"},
            {id:2, name:"é»’é‰›", type:"lightning", val:20, cost:1, rarity:1, img:"C", desc:"é›»æ°—ã‚’é€šã™ç‚­ç´ ã®åŒç´ ä½“ã€‚"},
            {id:3, name:"å¡©é…¸", type:"water", val:50, cost:2, rarity:2, img:"HCl", desc:"å¼·ã„é…¸æ€§ã‚’ç¤ºã™æ¶²ä½“ã€‚èƒƒæ¶²ã®æˆåˆ†ã€‚"},
            {id:4, name:"ã‚¢ãƒ³ãƒ¢ãƒ‹ã‚¢", type:"grass", val:40, cost:2, rarity:2, img:"NHâ‚ƒ", desc:"åˆºæ¿€è‡­ãŒã‚ã‚Šã€æ°´ã«æº¶ã‘ã¦å¡©åŸºæ€§ã‚’ç¤ºã™ã€‚"},
            {id:5, name:"ãƒ™ãƒ³ã‚¼ãƒ³", type:"metal", val:50, cost:3, rarity:3, img:"Câ‚†Hâ‚†", desc:"å®‰å®šã—ãŸç’°çŠ¶æ§‹é€ ã‚’æŒã¤æœ‰æ©ŸåŒ–åˆç‰©ã€‚"},
            {id:6, name:"ç‹æ°´", type:"fire", val:80, cost:3, rarity:3, img:"Auæº¶", desc:"é‡‘ã‚„ç™½é‡‘ã‚’ã‚‚æº¶ã‹ã™ã€æœ€å¼·ã‚¯ãƒ©ã‚¹ã®é…¸ã€‚"}
        ];
        const quizList = [
            {q:"åŸå­ç•ªå·1ç•ªã®å…ƒç´ ã¯ï¼Ÿ", a:0, o:["æ°´ç´ ","ãƒ˜ãƒªã‚¦ãƒ ","ãƒªãƒã‚¦ãƒ "]},
            {q:"ãƒŠãƒˆãƒªã‚¦ãƒ (Na)ã®ç‚è‰²åå¿œã¯ä½•è‰²ï¼Ÿ", a:1, o:["èµ¤è‰²","é»„è‰²","ç·‘è‰²"]},
            {q:"è…åµè‡­ï¼ˆåµãŒè…ã£ãŸè‡­ã„ï¼‰ãŒã™ã‚‹æ°—ä½“ã¯ï¼Ÿ", a:0, o:["ç¡«åŒ–æ°´ç´ ","é…¸ç´ ","çª’ç´ "]}
        ];

        // --- å¤‰æ•° ---
        let user=null, myCards=[], energy=500;
        let enemyMaxHp=200, enemyHp=200, playerMaxHp=100, playerHp=100;
        let playerMana=0; const maxMana=5;
        let selectedCard=null, isTurn=false;

        // --- ã‚·ã‚¹ãƒ†ãƒ  ---
        function login() {
            const name = document.getElementById('login-name').value;
            if(!name) return;
            user = name;
            const saved = localStorage.getItem('chemModernTCG_'+user);
            if(saved) { const d=JSON.parse(saved); myCards=d.cards; energy=d.energy; }
            else { myCards=[cards[0],cards[1]]; saveData(); }
            document.getElementById('header-username').innerText = user;
            updateGlobalUI();
            document.getElementById('hud').style.display = 'flex';
            document.getElementById('bottom-nav').style.display = 'flex';
            navTo('home');
        }
        function saveData(){ if(user) localStorage.setItem('chemModernTCG_'+user, JSON.stringify({cards:myCards,energy:energy})); }
        function updateGlobalUI(){ document.getElementById('energy-val').innerText=energy; document.getElementById('card-count').innerText=myCards.length; }
        function navTo(screenId){
            document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
            document.getElementById('screen-'+screenId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
            if(screenId==='home') document.querySelectorAll('.nav-item')[0].classList.add('active');
            if(screenId==='battle') document.querySelectorAll('.nav-item')[1].classList.add('active');
            if(screenId==='gacha') document.querySelectorAll('.nav-item')[2].classList.add('active');
        }

        // --- ãƒãƒˆãƒ« ---
        function initBattle(){
            navTo('battle'); enemyHp=enemyMaxHp; playerHp=playerMaxHp; playerMana=0; selectedCard=null; isTurn=true;
            updateBattleUI(); document.getElementById('active-slot').innerHTML="ã‚«ãƒ¼ãƒ‰ã‚’ã‚»ãƒƒãƒˆ"; document.getElementById('active-slot').style.background="rgba(255,255,255,0.5)"; document.getElementById('attack-btn').style.display='none';
        }
        function updateBattleUI(){
            document.getElementById('enemy-hp-bar').style.width=(enemyHp/enemyMaxHp)*100+"%"; document.getElementById('enemy-hp-text').innerText=enemyHp;
            document.getElementById('player-hp-bar').style.width=(playerHp/playerMaxHp)*100+"%"; document.getElementById('player-hp-text').innerText=playerHp;
            const mBox=document.getElementById('mana-gauge'); mBox.innerHTML="";
            for(let i=0; i<maxMana; i++){
                const d=document.createElement('div'); d.className=`mana-icon ${i<playerMana?'active':''}`; d.innerText="âš¡"; mBox.appendChild(d);
            }
            renderHand();
        }
        
        // â˜…ã‚«ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆãƒã‚±ã‚«é¢¨HTML - ãƒ¢ãƒ€ãƒ³ç‰ˆï¼‰
        function createPokeCardHTML(c) {
            let costOrbs = "";
            for(let i=0; i<c.cost; i++) costOrbs += `<div class="cost-orb filled"></div>`;
            
            return `
                <div class="pokeca-card type-${c.type} rarity-${c.rarity} in-hand">
                    <div class="pc-header">
                        <span>${c.name}</span><span class="pc-hp">HP 60</span>
                    </div>
                    <div class="pc-image-box">${c.img}</div>
                    <div class="pc-body">
                        <div class="pc-move">
                            <div class="pc-cost">${costOrbs}</div>
                            <div class="pc-move-name">æ”»æ’ƒ</div>
                            <div class="pc-damage">${c.val}</div>
                        </div>
                        <div class="pc-desc">${c.desc}</div>
                    </div>
                </div>`;
        }

        function renderHand(){
            const el=document.getElementById('hand-container'); el.innerHTML="";
            myCards.slice().reverse().forEach(c=>{
                const div=document.createElement('div');
                div.innerHTML = createPokeCardHTML(c);
                const cardEl = div.firstElementChild;
                if(c.cost>playerMana) cardEl.classList.add('disabled');
                cardEl.onclick=()=>selectCard(c, cardEl);
                el.appendChild(cardEl);
            });
        }
        function selectCard(c, div){
            if(!isTurn) return; if(c.cost>playerMana) return alert("ã‚¨ãƒŠã‚¸ãƒ¼ãŒè¶³ã‚Šã¾ã›ã‚“");
            document.querySelectorAll('.pokeca-card').forEach(d=>d.classList.remove('selected'));
            div.classList.add('selected'); selectedCard=c;
            
            const slot = document.getElementById('active-slot');
            slot.innerHTML = div.outerHTML;
            slot.style.background = "transparent";
            slot.children[0].classList.remove('selected','disabled','in-hand');
            slot.children[0].style.transform = "scale(0.9)"; // ã‚¹ãƒ­ãƒƒãƒˆã«åã¾ã‚‹ã‚ˆã†ã«å°‘ã—å°ã•ã

            document.getElementById('attack-btn').style.display='block';
        }
        function openChargeQuiz(){
            if(!isTurn) return; if(playerMana>=maxMana) return alert("ã‚¨ãƒŠã‚¸ãƒ¼ã¯æº€ã‚¿ãƒ³ã§ã™");
            const q=quizList[Math.floor(Math.random()*quizList.length)];
            document.getElementById('q-text').innerText=q.q;
            const opts=document.getElementById('q-options'); opts.innerHTML="";
            q.o.forEach((txt,i)=>{
                const b=document.createElement('button'); b.className="game-btn btn-yellow"; b.style.width="100%"; b.innerText=txt;
                b.onclick=()=>{
                    document.getElementById('quiz-modal').style.display='none';
                    if(i===q.a){ playerMana=Math.min(maxMana, playerMana+2); alert("ãƒãƒ£ãƒ¼ã‚¸æˆåŠŸï¼ (+2)"); updateBattleUI(); }
                    else{ alert("å¤±æ•—..."); }
                };
                opts.appendChild(b);
            });
            document.getElementById('quiz-modal').style.display='flex';
        }
        function playerAttack(){
            if(!isTurn||!selectedCard) return; playerMana-=selectedCard.cost; isTurn=false;
            document.getElementById('attack-btn').style.display='none'; updateBattleUI();
            const dmg=selectedCard.val; enemyHp=Math.max(0,enemyHp-dmg); updateBattleUI();
            if(enemyHp<=0) setTimeout(()=>{ alert("å‹åˆ©ï¼ ã‚¨ãƒŠã‚¸ãƒ¼+200GET!"); energy+=200; saveData(); updateGlobalUI(); navTo('home'); },1000);
            else setTimeout(()=>{
                alert("æ•µã®æ”»æ’ƒ! -30ãƒ€ãƒ¡ãƒ¼ã‚¸"); playerHp=Math.max(0,playerHp-30); updateBattleUI();
                if(playerHp<=0){ alert("æ•—åŒ—..."); navTo('home'); } else isTurn=true;
            },1500);
        }

        // --- ã‚¬ãƒãƒ£ ---
        function tryGacha(){
            if(energy<300) return alert("ã‚¨ãƒŠã‚¸ãƒ¼ãŒè¶³ã‚Šã¾ã›ã‚“"); energy-=300; updateGlobalUI(); saveData();
            const r=Math.random(); let rarity=1; if(r<0.2) rarity=3; else if(r<0.5) rarity=2;
            const hit=cards.filter(c=>c.rarity===rarity)[0]; myCards.push(hit); saveData(); updateGlobalUI();
            
            const div = document.createElement('div');
            div.innerHTML = createPokeCardHTML(hit);
            const cardEl = div.firstElementChild;
            cardEl.classList.remove('in-hand');
            cardEl.style.transform = "scale(1.5)";

            document.getElementById('new-card-view').innerHTML="";
            document.getElementById('new-card-view').appendChild(cardEl);
            document.getElementById('card-modal').style.display='flex';
        }
        function closeModal(id){ document.getElementById(id).style.display='none'; }
    </script>
</body>
</html>