<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…ƒç´ ã‚¯ãƒ­ãƒ‹ã‚¯ãƒ« - è¦šé†’</title>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;700&family=M+PLUS+1p:wght@800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* --- å’Œé¢¨ãƒ‡ã‚¶ã‚¤ãƒ³ã®ãƒ™ãƒ¼ã‚¹è‰² --- */
            --bg-base: #050505;
            --bg-panel: rgba(20, 20, 20, 0.9);
            --gold-main: #c5a059;
            --gold-dim: #8a6e3e;
            --accent-red: #a82338;
            --text-white: #e0e0e0;
            --font-wa: 'Shippori Mincho', serif;
            --font-poke: 'M PLUS 1p', sans-serif;

            /* --- ãƒã‚±ã‚«é¢¨ã‚«ãƒ¼ãƒ‰ã®è‰² --- */
            --type-fire: #ff4757;
            --type-water: #1e90ff;
            --type-grass: #2ed573;
            --type-lightning: #ffd700;
            --type-metal: #747d8c;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-base);
            /* å’Œç´™ã®ã‚ˆã†ãªå¾®ç´°ãªãƒã‚¤ã‚º */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            font-family: var(--font-wa);
            color: var(--text-white);
            height: 100dvh; width: 100vw;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- å…±é€šãƒ‘ãƒ¼ãƒ„ (å’Œé¢¨ç¶­æŒ) --- */
        .header-hud {
            height: 60px; width: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; position: fixed; top: 0; z-index: 100;
            border-bottom: 1px solid var(--gold-dim);
        }
        .user-info { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; letter-spacing: 1px; color: var(--gold-main); }
        .energy-bar {
            background: rgba(0,0,0,0.5); padding: 5px 15px; border: 1px solid var(--gold-main);
            color: var(--gold-main); font-weight: bold; display: flex; align-items: center; gap: 8px;
        }

        .bottom-nav {
            height: 80px; width: 100%; background: #0a0a0a;
            display: flex; justify-content: space-around; align-items: center;
            position: fixed; bottom: 0; z-index: 100;
            border-top: 2px solid var(--gold-dim); padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #555; font-size: 0.7rem; gap: 6px; cursor: pointer; transition: 0.3s;
            font-family: var(--font-wa); letter-spacing: 2px;
        }
        .nav-item.active { color: var(--gold-main); text-shadow: 0 0 8px var(--gold-dim); }
        .nav-icon { font-size: 1.5rem; }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; align-items: center;
            padding: 20px; padding-bottom: 90px; overflow-y: auto;
            animation: fadeIn 0.5s ease;
        }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        /* ãƒœã‚¿ãƒ³ (å’Œé¢¨) */
        .game-btn {
            background: transparent; border: 1px solid var(--gold-main); color: var(--gold-main);
            padding: 15px 40px; font-family: var(--font-wa); font-size: 1rem; letter-spacing: 3px;
            cursor: pointer; transition: 0.3s; width: 80%; max-width: 300px; margin: 10px 0;
            position: relative; overflow: hidden;
        }
        .game-btn:hover { background: var(--gold-main); color: #000; box-shadow: 0 0 20px var(--gold-dim); }
        .input-field { background: transparent; border: none; border-bottom: 1px solid #555; color: white; padding: 10px; width: 80%; margin-bottom: 40px; font-size: 1.2rem; text-align: center; font-family: var(--font-wa); }

        /* --- â˜…ã“ã“ã«æ³¨ç›®ï¼ ãƒã‚±ã‚«é¢¨ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
        .pokeca-card {
            width: 160px; height: 220px; flex-shrink: 0;
            border-radius: 10px;
            /* å±æ€§è‰²ã§æ ç·šã‚’å¤‰åŒ–ã•ã›ã‚‹ */
            border: 4px solid #ccc; background: #fff;
            display: flex; flex-direction: column;
            position: relative; overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            font-family: var(--font-poke); color: #333;
        }
        /* å±æ€§åˆ¥ã®è‰²å®šç¾© */
        .type-fire { border-color: var(--type-fire); background: linear-gradient(135deg, #fff, #ffcccc); }
        .type-water { border-color: var(--type-water); background: linear-gradient(135deg, #fff, #ccf0ff); }
        .type-grass { border-color: var(--type-grass); background: linear-gradient(135deg, #fff, #ccffcc); }
        .type-lightning { border-color: var(--type-lightning); background: linear-gradient(135deg, #fff, #ffffcc); }
        .type-metal { border-color: var(--type-metal); background: linear-gradient(135deg, #fff, #e0e0e0); }

        /* ãƒ›ãƒ­ã‚°ãƒ©ãƒ åŠ å·¥ (æœ€é«˜ãƒ¬ã‚¢ãƒªãƒ†ã‚£ç”¨) */
        .rarity-3::after {
            content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(115deg, transparent 30%, rgba(255,255,255,0.8) 45%, rgba(255,255,255,0.0) 50%, rgba(255,215,0,0.5) 55%, transparent 70%);
            background-size: 200% 200%; animation: holoShine 3s infinite linear;
            pointer-events: none; mix-blend-mode: overlay; opacity: 0.7;
        }
        @keyframes holoShine { 0%{background-position: 150% 0} 100%{background-position: -50% 0} }

        /* ã‚«ãƒ¼ãƒ‰ã®æ§‹é€  */
        .pc-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 4px 8px; font-weight: 900; font-size: 0.9rem;
        }
        .pc-hp { color: var(--accent-red); }
        
        .pc-image-box {
            width: 94%; height: 90px; margin: 0 auto;
            border: 2px solid rgba(0,0,0,0.2); box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
            display: flex; justify-content: center; align-items: center;
            background: #fff; overflow: hidden; font-size: 3rem;
        }

        .pc-body { flex: 1; padding: 8px; display: flex; flex-direction: column; }
        
        .pc-move {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 4px; margin-bottom: 4px;
        }
        .pc-cost {
            display: flex; gap: 2px;
        }
        .cost-orb {
            width: 12px; height: 12px; border-radius: 50%; background: #ccc;
            border: 1px solid rgba(0,0,0,0.3);
        }
        .cost-orb.filled { background: var(--gold-main); box-shadow: 0 0 5px var(--gold-main); }
        
        .pc-move-name { font-weight: 900; font-size: 1rem; }
        .pc-damage { font-size: 1.2rem; font-weight: 900; }
        
        .pc-desc {
            font-size: 0.6rem; color: #555; line-height: 1.2;
            margin-top: auto; font-family: var(--font-wa);
        }

        /* æ‰‹æœ­ã§ã®æŒ™å‹• */
        .pokeca-card.in-hand:hover {
            transform: translateY(-40px) scale(1.2) !important; z-index: 100;
        }
        .pokeca-card.selected {
            transform: translateY(-30px) scale(1.1) !important; z-index: 50;
            box-shadow: 0 0 30px var(--gold-main); border-color: var(--gold-main);
        }
        .pokeca-card.disabled { filter: grayscale(1) brightness(0.6); }

        /* --- ãƒãƒˆãƒ«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ (å’Œé¢¨ç¶­æŒ) --- */
        .battle-container { width: 100%; height: 100%; display: flex; flex-direction: column; }
        .unit-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        
        /* æ•µã‚¨ãƒªã‚¢ */
        .boss-card-wa {
            width: 140px; height: 180px; background: #2a0a0a; border: 3px solid var(--accent-red);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 0 30px rgba(168, 35, 56, 0.5);
        }
        .hp-bar-wrap { width: 240px; margin-top: 10px; position: relative; }
        .hp-bar-bg { width: 100%; height: 6px; background: #333; overflow: hidden; }
        .hp-bar-fill { height: 100%; width: 100%; transition: width 0.5s ease; }
        .hp-enemy { background: var(--accent-red); box-shadow: 0 0 10px var(--accent-red); }
        .hp-player { background: var(--gold-main); box-shadow: 0 0 10px var(--gold-main); }
        .hp-text { position: absolute; top: -20px; width: 100%; text-align: right; font-size: 0.8rem; letter-spacing: 1px; }

        /* ãƒãƒŠ (å’Œé¢¨å‹¾ç‰) */
        .mana-gauge { display: flex; gap: 8px; margin-top: 10px; }
        .mana-magatama { 
            width: 12px; height: 18px; background: #333; border: 1px solid var(--gold-dim); 
            border-radius: 50% 50% 50% 0; transform: rotate(45deg); transition: 0.4s;
        }
        .mana-magatama.active { background: var(--gold-main); box-shadow: 0 0 10px var(--gold-main); }

        /* æ‰‹æœ­ã‚¨ãƒªã‚¢ */
        .hand-scroll {
            height: 240px; width: 100%; display: flex; align-items: center; gap: 10px;
            overflow-x: auto; padding: 0 25px; 
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            border-top: 1px solid var(--gold-dim);
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« (å’Œé¢¨) */
        .modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9);
            display: none; justify-content: center; align-items: center; z-index: 300; backdrop-filter: blur(5px);
        }
        .modal-box {
            background: #111; width: 90%; max-width: 400px; padding: 30px; 
            text-align: center; border: 2px solid var(--gold-main); box-shadow: 0 0 50px rgba(197, 160, 89, 0.3);
        }
        .modal-title { color: var(--gold-main); letter-spacing: 3px; margin-bottom: 20px; font-family: var(--font-wa); }

    </style>
</head>
<body>

    <header class="header-hud" id="hud" style="display: none;">
        <div class="user-info"><span style="font-size:1.2rem;">â—ˆ</span> <span id="header-username">GUEST</span></div>
        <div class="energy-bar">éœŠåŠ› <span id="energy-val">0</span></div>
    </header>

    <div id="screen-login" class="screen active" style="justify-content:center;">
        <h1 style="font-size:3rem; letter-spacing:5px; color:var(--gold-main); text-shadow:0 0 20px var(--gold-dim);">å…ƒç´ ã‚¯ãƒ­ãƒ‹ã‚¯ãƒ«</h1>
        <p style="color:#aaa; letter-spacing:3px; margin-bottom:50px; font-family:var(--font-wa);">ç‰©è³ªå¬å–šä¹‹å„€</p>
        <input type="text" id="login-name" class="input-field" placeholder="åãƒ²åãƒãƒ¬">
        <button class="game-btn" onclick="login()">é–‹å§‹ã‚¹ãƒ«</button>
    </div>

    <div id="screen-home" class="screen">
        <h2 style="letter-spacing:3px; color:var(--gold-main); border-bottom:1px solid var(--gold-dim); width:100%; padding-bottom:10px;">æ‹ ç‚¹</h2>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; width:100%; margin-top:30px;">
            <div style="border:1px solid var(--gold-dim); padding:20px; text-align:center;">
                <div style="font-size:1.5rem; margin-bottom:10px; color:var(--gold-main);">â–</div>
                <h3 style="margin:0; font-size:0.8rem; color:#aaa;">æ‰€æŒç¬¦</h3>
                <div id="card-count" style="font-size:1.5rem; margin-top:5px;">0</div>
            </div>
        </div>
    </div>

    <div id="screen-battle" class="screen" style="padding:0;">
        <div class="battle-container">
            <div class="unit-area">
                <div class="boss-card-wa">
                    <div style="font-size:4rem;">ğŸ‘¹</div>
                    <div style="font-family:var(--font-wa); color:var(--accent-red); font-weight:bold;">å¼·é…¸ãƒé¬¼ï¼šæ¿ƒç¡«é…¸</div>
                </div>
                <div class="hp-bar-wrap">
                    <div class="hp-text"><span id="enemy-hp-text">200</span> / 200</div>
                    <div class="hp-bar-bg"><div id="enemy-hp-bar" class="hp-bar-fill hp-enemy"></div></div>
                </div>
            </div>

            <div class="unit-area">
                <div id="active-slot" style="width:120px; height:160px; border:1px solid var(--gold-dim); display:flex; justify-content:center; align-items:center; color:var(--gold-dim); font-family:var(--font-wa); font-size:0.8rem; margin-bottom:20px;">
                    ç¬¦ãƒ²é¸æŠã‚»ãƒ¨
                </div>
                <div style="display:flex; gap:15px;">
                    <button class="game-btn" onclick="openChargeQuiz()" style="width:auto; padding:10px 25px; font-size:0.9rem;">å……å¡«</button>
                    <button id="attack-btn" class="game-btn" onclick="playerAttack()" style="width:auto; padding:10px 25px; font-size:0.9rem; background:var(--gold-main); color:#000; display:none;">ç™ºå‹•</button>
                </div>
            </div>

            <div class="unit-area" style="justify-content:flex-end; padding-bottom:10px;">
                <div style="display:flex; justify-content:space-between; width:100%; padding:0 30px; align-items:flex-end; margin-bottom:10px;">
                    <div class="hp-bar-wrap" style="width:140px;">
                        <div class="hp-text" style="text-align:left;">æˆ‘ã‚¬æ–¹</div>
                        <div class="hp-bar-bg"><div id="player-hp-bar" class="hp-bar-fill hp-player"></div></div>
                        <div style="font-size:0.7rem; color:#aaa; margin-top:3px;"><span id="player-hp-text">100</span></div>
                    </div>
                    <div>
                        <div style="font-size:0.6rem; letter-spacing:1px; color:#aaa; text-align:right;">è§¦åª’ (ãƒãƒŠ)</div>
                        <div class="mana-gauge" id="mana-gauge"></div>
                    </div>
                </div>
                <div class="hand-scroll" id="hand-container">
                    </div>
            </div>
        </div>
    </div>

    <div id="screen-gacha" class="screen" style="justify-content:center;">
        <h2 class="modal-title">ç‰©è³ªç”Ÿæˆãƒå„€</h2>
        <div style="width:150px; height:200px; border:2px solid var(--gold-main); display:flex; justify-content:center; align-items:center; font-size:3rem; color:var(--gold-main); cursor:pointer; background:rgba(0,0,0,0.5);" onclick="tryGacha()">
            ğŸ´
        </div>
        <div style="margin-top:30px; color:#aaa; font-family:var(--font-wa); letter-spacing:2px;">
            æ¶ˆè²»éœŠåŠ›: 300
        </div>
    </div>

    <nav class="bottom-nav" id="bottom-nav" style="display:none;">
        <div class="nav-item active" onclick="navTo('home')"><div class="nav-icon">â–</div>æ‹ ç‚¹</div>
        <div class="nav-item" onclick="initBattle()"><div class="nav-icon">âš”</div>æ±ºæˆ¦</div>
        <div class="nav-item" onclick="navTo('gacha')"><div class="nav-icon">ğŸ´</div>ç”Ÿæˆ</div>
    </nav>

    <div id="quiz-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title">è§¦åª’å……å¡«ãƒè©¦ç·´</h3>
            <p id="q-text" style="margin:30px 0; font-family:var(--font-wa); line-height:1.6; font-size:1.1rem;"></p>
            <div id="q-options" style="display:flex; flex-direction:column; gap:15px;"></div>
        </div>
    </div>

    <div id="card-modal" class="modal-overlay">
        <div class="modal-box" style="background:transparent; border:none; box-shadow:none;">
            <h2 class="modal-title" style="text-shadow:0 0 10px black;">å¬å–šæˆåŠŸ</h2>
            <div id="new-card-view" style="display:flex; justify-content:center; margin:30px 0;"></div>
            <button class="game-btn" onclick="closeModal('card-modal')" style="background:var(--gold-main); color:black;">å—å–ãƒ«</button>
        </div>
    </div>

    <script>
        // --- ãƒ‡ãƒ¼ã‚¿ (å±æ€§typeã‚’è¿½åŠ ) ---
        const cards = [
            {id:1, name:"æ°´ç´ ", type:"fire", val:30, cost:1, rarity:1, img:"Hâ‚‚", desc:"æœ€ã‚‚è»½ã„å…ƒç´ ã€‚ç‡ƒãˆã‚„ã™ã„ã€‚"},
            {id:2, name:"é»’é‰›", type:"lightning", val:20, cost:1, rarity:1, img:"C", desc:"é›»æ°—ã‚’é€šã™ç‚­ç´ ã®åŒç´ ä½“ã€‚"},
            {id:3, name:"å¡©é…¸", type:"water", val:50, cost:2, rarity:2, img:"HCl", desc:"å¼·ã„é…¸æ€§ã‚’ç¤ºã™æ¶²ä½“ã€‚"},
            {id:4, name:"ã‚¢ãƒ³ãƒ¢ãƒ‹ã‚¢", type:"grass", val:40, cost:2, rarity:2, img:"NHâ‚ƒ", desc:"æ°´ã«æº¶ã‘ã¦å¡©åŸºæ€§ã‚’ç¤ºã™ã€‚"},
            {id:5, name:"ãƒ™ãƒ³ã‚¼ãƒ³", type:"metal", val:50, cost:3, rarity:3, img:"Câ‚†Hâ‚†", desc:"å®‰å®šã—ãŸç’°çŠ¶æ§‹é€ ã‚’æŒã¤ã€‚"},
            {id:6, name:"ç‹æ°´", type:"fire", val:80, cost:3, rarity:3, img:"Auæº¶", desc:"é‡‘ã‚’ã‚‚æº¶ã‹ã™æœ€å¼·ã®é…¸ã€‚"}
        ];
        const quizList = [
            {q:"åŸå­ç•ªå·1ç•ªã¯ï¼Ÿ", a:0, o:["æ°´ç´ ","ãƒ˜ãƒªã‚¦ãƒ ","ãƒªãƒã‚¦ãƒ "]},
            {q:"Naã®ç‚è‰²åå¿œã¯ï¼Ÿ", a:1, o:["èµ¤","é»„","ç·‘"]},
            {q:"è…åµè‡­ãŒã™ã‚‹ã®ã¯ï¼Ÿ", a:0, o:["ç¡«åŒ–æ°´ç´ ","é…¸ç´ ","çª’ç´ "]}
        ];

        // --- å¤‰æ•° ---
        let user=null, myCards=[], energy=500;
        let enemyMaxHp=200, enemyHp=200, playerMaxHp=100, playerHp=100;
        let playerMana=0; const maxMana=5;
        let selectedCard=null, isTurn=false;

        // --- ã‚·ã‚¹ãƒ†ãƒ  ---
        function login() {
            const name = document.getElementById('login-name').value;
            if(!name) return;
            user = name;
            const saved = localStorage.getItem('chemWaPoke_'+user);
            if(saved) { const d=JSON.parse(saved); myCards=d.cards; energy=d.energy; }
            else { myCards=[cards[0],cards[1]]; saveData(); }
            document.getElementById('header-username').innerText = user;
            updateGlobalUI();
            document.getElementById('hud').style.display = 'flex';
            document.getElementById('bottom-nav').style.display = 'flex';
            navTo('home');
        }
        function saveData(){ if(user) localStorage.setItem('chemWaPoke_'+user, JSON.stringify({cards:myCards,energy:energy})); }
        function updateGlobalUI(){ document.getElementById('energy-val').innerText=energy; document.getElementById('card-count').innerText=myCards.length; }
        function navTo(screenId){
            document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
            document.getElementById('screen-'+screenId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
            if(screenId==='home') document.querySelectorAll('.nav-item')[0].classList.add('active');
            if(screenId==='battle') document.querySelectorAll('.nav-item')[1].classList.add('active');
            if(screenId==='gacha') document.querySelectorAll('.nav-item')[2].classList.add('active');
        }

        // --- ãƒãƒˆãƒ« ---
        function initBattle(){
            navTo('battle'); enemyHp=enemyMaxHp; playerHp=playerMaxHp; playerMana=0; selectedCard=null; isTurn=true;
            updateBattleUI(); document.getElementById('active-slot').innerHTML="ç¬¦ãƒ²é¸æŠã‚»ãƒ¨"; document.getElementById('attack-btn').style.display='none';
        }
        function updateBattleUI(){
            document.getElementById('enemy-hp-bar').style.width=(enemyHp/enemyMaxHp)*100+"%"; document.getElementById('enemy-hp-text').innerText=enemyHp;
            document.getElementById('player-hp-bar').style.width=(playerHp/playerMaxHp)*100+"%"; document.getElementById('player-hp-text').innerText=playerHp;
            const mBox=document.getElementById('mana-gauge'); mBox.innerHTML="";
            for(let i=0; i<maxMana; i++){
                const d=document.createElement('div'); d.className=`mana-magatama ${i<playerMana?'active':''}`; mBox.appendChild(d);
            }
            renderHand();
        }
        
        // â˜…ã‚«ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆãƒã‚±ã‚«é¢¨HTMLï¼‰
        function createPokeCardHTML(c) {
            let costOrbs = "";
            for(let i=0; i<c.cost; i++) costOrbs += `<div class="cost-orb filled"></div>`;
            for(let i=c.cost; i<3; i++) costOrbs += `<div class="cost-orb"></div>`; // æœ€å¤§3ã¤ã¾ã§è¡¨ç¤º

            return `
                <div class="pokeca-card type-${c.type} rarity-${c.rarity} in-hand">
                    <div class="pc-header">
                        <span>${c.name}</span><span class="pc-hp">HP 60</span>
                    </div>
                    <div class="pc-image-box">${c.img}</div>
                    <div class="pc-body">
                        <div class="pc-move">
                            <div class="pc-cost">${costOrbs}</div>
                            <div class="pc-move-name">æ”»æ’ƒ</div>
                            <div class="pc-damage">${c.val}</div>
                        </div>
                        <div class="pc-desc">${c.desc}</div>
                    </div>
                </div>`;
        }

        function renderHand(){
            const el=document.getElementById('hand-container'); el.innerHTML="";
            myCards.slice().reverse().forEach(c=>{
                const div=document.createElement('div');
                div.innerHTML = createPokeCardHTML(c);
                const cardEl = div.firstElementChild;
                if(c.cost>playerMana) cardEl.classList.add('disabled');
                cardEl.onclick=()=>selectCard(c, cardEl);
                el.appendChild(cardEl);
            });
        }
        function selectCard(c, div){
            if(!isTurn) return; if(c.cost>playerMana) return alert("è§¦åª’ä¸è¶³");
            document.querySelectorAll('.pokeca-card').forEach(d=>d.classList.remove('selected'));
            div.classList.add('selected'); selectedCard=c;
            document.getElementById('active-slot').innerHTML = div.outerHTML;
            document.getElementById('active-slot').children[0].classList.remove('selected','disabled','in-hand');
            document.getElementById('attack-btn').style.display='block';
        }
        function openChargeQuiz(){
            if(!isTurn) return; if(playerMana>=maxMana) return alert("å……å¡«å®Œäº†ãƒŠãƒª");
            const q=quizList[Math.floor(Math.random()*quizList.length)];
            document.getElementById('q-text').innerText=q.q;
            const opts=document.getElementById('q-options'); opts.innerHTML="";
            q.o.forEach((txt,i)=>{
                const b=document.createElement('button'); b.className="game-btn"; b.style.width="100%"; b.innerText=txt;
                b.onclick=()=>{
                    document.getElementById('quiz-modal').style.display='none';
                    if(i===q.a){ playerMana=Math.min(maxMana, playerMana+2); alert("å……å¡«æˆåŠŸ (+2)"); updateBattleUI(); }
                    else{ alert("å¤±æ•—..."); }
                };
                opts.appendChild(b);
            });
            document.getElementById('quiz-modal').style.display='flex';
        }
        function playerAttack(){
            if(!isTurn||!selectedCard) return; playerMana-=selectedCard.cost; isTurn=false;
            document.getElementById('attack-btn').style.display='none'; updateBattleUI();
            const dmg=selectedCard.val; enemyHp=Math.max(0,enemyHp-dmg); updateBattleUI();
            if(enemyHp<=0) setTimeout(()=>{ alert("å‹åˆ©! +200éœŠåŠ›"); energy+=200; saveData(); updateGlobalUI(); navTo('home'); },1000);
            else setTimeout(()=>{
                alert("æ•µãƒåæ’ƒ! -30"); playerHp=Math.max(0,playerHp-30); updateBattleUI();
                if(playerHp<=0){ alert("æ•—åŒ—..."); navTo('home'); } else isTurn=true;
            },1500);
        }

        // --- ã‚¬ãƒãƒ£ ---
        function tryGacha(){
            if(energy<300) return alert("éœŠåŠ›ä¸è¶³"); energy-=300; updateGlobalUI(); saveData();
            const r=Math.random(); let rarity=1; if(r<0.2) rarity=3; else if(r<0.5) rarity=2;
            const hit=cards.filter(c=>c.rarity===rarity)[0]; myCards.push(hit); saveData(); updateGlobalUI();
            
            const div = document.createElement('div');
            div.innerHTML = createPokeCardHTML(hit);
            const cardEl = div.firstElementChild;
            cardEl.classList.remove('in-hand');
            cardEl.style.transform = "scale(1.5)";

            document.getElementById('new-card-view').innerHTML="";
            document.getElementById('new-card-view').appendChild(cardEl);
            document.getElementById('card-modal').style.display='flex';
        }
        function closeModal(id){ document.getElementById(id).style.display='none'; }
    </script>
</body>
</html>